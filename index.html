
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSB APP - Sistema de Mantenimiento v3.0 Completo</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Sistema de Mantenimiento Preventivo en Tiempo Real">
    
    <!-- Meta tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HSB App">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-72.png">
    
    <!-- Firebase SDK - Versi√≥n 10.8.0 (m√°s reciente y estable) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    
    <script>
        // Verificar inmediatamente si Firebase se est√° cargando
        console.log('üì¶ Scripts de Firebase solicitados desde CDN');
        window.addEventListener('load', function() {
            if (typeof firebase === 'undefined') {
                console.error('‚ùå Firebase NO se carg√≥ desde el CDN');
                console.error('üîç Verifica que no haya bloqueadores o problemas de red');
            } else {
                console.log('‚úÖ Firebase disponible desde el CDN');
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .login-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #1e3c72;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-text h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .header-text p {
            opacity: 0.9;
            font-size: 12px;
        }

        .header-right {
            text-align: right;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.4);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #1e3c72;
            border-bottom: 3px solid #1e3c72;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input.pending {
            border-color: #ff9800;
            background-color: #fff3e0;
        }

        input.completed {
            border-color: #4caf50;
            background-color: #f1f8f4;
        }

        input.alert {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .alert-message {
            background: #dc3545;
            color: white;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .ok-message {
            background: #28a745;
            color: white;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .section-list {
            display: grid;
            gap: 15px;
        }

        .section-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-card:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .section-info h3 {
            color: #1e3c72;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .section-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
        }

        .section-icon {
            font-size: 40px;
        }

        .section-view {
            display: none;
        }

        .section-view.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-header h2 {
            color: #1e3c72;
            font-size: 22px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-back {
            background: #6c757d;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 3px;
        }

        .activity-field {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .activity-field.pending {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .activity-field.completed {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 10px;
        }

        .photo-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .photo-upload:hover {
            background: #f8f9fa;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #1e3c72;
            font-size: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .sync-indicator.syncing {
            display: block;
            color: #667eea;
        }

        .sync-indicator.synced {
            display: block;
            color: #28a745;
        }

        .hidden {
            display: none !important;
        }

        .report-summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .header-right {
                margin-top: 10px;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator">
        üîÑ Sincronizando...
    </div>

    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>üßä HSB APP v3.0 Complete</h1>
            <p>Sistema de Mantenimiento - Firebase Sync</p>
        </div>
        <div id="loginLoading" style="text-align: center; padding: 20px;">
            <div class="loading-spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 15px; color: #666;">Cargando datos desde Firebase...</p>
        </div>
        <form id="loginForm" style="display: none;">
            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="loginUsername" required autocomplete="username">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="loginPassword" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn">üîê Iniciar Sesi√≥n</button>
        </form>
        <div id="loginError" style="color: #dc3545; margin-top: 15px; text-align: center; display: none;"></div>
    </div>

    <!-- PANTALLA PRINCIPAL -->
    <div id="mainScreen" class="container hidden">
        <div class="header">
            <div class="header-left">
                <img src="Logo_HSB_APP.png" alt="HSB Logo" style="height: 50px; margin-right: 15px; border-radius: 8px;">
                <div class="header-text">
                    <h1>Sistema de Mantenimiento HSB v3.0</h1>
                    <p>Con sincronizaci√≥n en tiempo real</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <strong id="currentUserName"></strong>
                    <div><small id="currentUserRole"></small></div>
                </div>
                
                <div id="systemClock" style="background: #667eea; color: white; padding: 8px 15px; border-radius: 8px; font-size: 13px; text-align: center; margin: 10px 0; font-family: monospace; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; font-size: 16px;" id="clockTime">--:--:--</div>
                    <div style="font-size: 11px; opacity: 0.9;" id="clockDate">Cargando...</div>
                    <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;" id="clockDay">D√≠a actual: --</div>
                </div>
                <button class="btn-logout" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="tabs" id="mainTabs"></div>

        <!-- TAB: REPORTE DIARIO -->
        <div id="tab-reporte-diario" class="tab-content">
            <div class="section-header">
                <h2>üìä Reporte Diario</h2>
                <div>
                    <button onclick="shareReport()" class="btn btn-secondary btn-small">üì± Compartir WhatsApp</button>
                </div>
            </div>
            <div id="reportContent"></div>
        </div>

        <!-- TAB: MANTENIMIENTO PREVENTIVO -->
        <div id="tab-mantenimiento-preventivo" class="tab-content">
            <div id="sectionsList" class="section-list">
                <div class="section-header">
                    <h2>üîß Mantenimiento Preventivo</h2>
                    <div id="currentDateDisplay" style="font-size: 16px; color: #667eea; font-weight: bold; margin-top: 5px;"></div>
                </div>
                <div id="sectionsContainer"></div>
            </div>

            <div id="sectionDetail" class="section-view">
                <div class="section-header">
                    <h2 id="sectionDetailTitle"></h2>
                    <button onclick="backToSectionsList()" class="btn btn-back">‚Üê Volver</button>
                </div>
                <div id="sectionDetailContent"></div>
                <button onclick="saveSectionAndReturn()" class="btn btn-secondary">‚úì Guardar y Volver</button>
            </div>
        </div>

        <!-- TAB: PLAN -->
        <div id="tab-plan" class="tab-content">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>üìÖ Plan de Mantenimiento Peri√≥dico</h2>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">Actividades programadas (semanal, mensual, anual, etc.)</p>
                </div>
                <button id="btnNewPlanActivity" onclick="openNewPlanActivityModal()" 
                        style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    ‚ûï Nueva Actividad Peri√≥dica
                </button>
            </div>
            <div id="planContent">
                <p style="text-align: center; color: #999; padding: 40px;">Cargando plan de mantenimiento...</p>
            </div>
        </div>

        <!-- TAB: HISTORIAL -->
        <div id="tab-historial" class="tab-content">
            <div class="section-header">
                <h2>üìã Historial</h2>
            </div>
            
            <!-- Selector de modo -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <button id="btnHistorialPorFecha" onclick="showHistorialMode('porFecha')" 
                        class="btn" style="flex: 1; background: #667eea; color: white; padding: 12px;">
                    üìÖ Por Fecha
                </button>
                <button id="btnHistorialPorSeccion" onclick="showHistorialMode('porSeccion')" 
                        class="btn" style="flex: 1; background: #6c757d; color: white; padding: 12px;">
                    üì¶ Por Equipo/√Årea
                </button>
            </div>
            
            <div id="historialContent"></div>
        </div>

        <!-- TAB: CONFIGURACI√ìN -->
        <div id="tab-configuracion" class="tab-content">
            <h2 style="color: #1e3c72; margin-bottom: 20px;">‚öôÔ∏è Panel de Configuraci√≥n</h2>
            <div id="configContent"></div>
        </div>
    </div>

    <!-- Modal para Novedades -->
    <div id="novedadesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Reportar Novedades</h2>
                <span class="close" onclick="closeNovedadesModal()">&times;</span>
            </div>
            <div id="novedadesModalContent"></div>
        </div>
    </div>

    <!-- MODAL: AGREGAR ACTIVIDAD -->
    <div id="addActivityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Agregar Nueva Actividad</h2>
                <span class="close" onclick="closeAddActivityModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label>Secci√≥n:</label>
                    <select id="activitySection" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Nombre de la Actividad:</label>
                    <input type="text" id="activityName" placeholder="Ej: Vibraci√≥n Motor" 
                           style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                </div>
                
                <div class="form-group">
                    <label>Tipo de Registro:</label>
                    <select id="activityType" onchange="toggleActivityFields()" 
                            style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        <option value="">-- Seleccionar --</option>
                        <option value="parametros">Par√°metros (valores num√©ricos)</option>
                        <option value="chequeo">Chequeo (OK/No OK)</option>
                        <option value="nivel_aceite">Nivel de Aceite (4 niveles)</option>
                    </select>
                </div>
                
                <div id="parametrosFields" style="display: none;">
                    <div class="form-group">
                        <label>Unidad:</label>
                        <input type="text" id="activityUnit" placeholder="Ej: PSI, ¬∞C, %, A" 
                               style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Valor M√≠nimo:</label>
                            <input type="number" step="0.1" id="activityMin" placeholder="Ej: 50" 
                                   style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <label>Valor M√°ximo:</label>
                            <input type="number" step="0.1" id="activityMax" placeholder="Ej: 100" 
                                   style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Frecuencia:</label>
                    <select id="activityFrequency" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        <option value="">-- Seleccionar --</option>
                        <option value="2 veces al dia">2 veces al d√≠a (Ma√±ana y Tarde)</option>
                        <option value="Diario">Diario (Una vez al d√≠a)</option>
                    </select>
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #2196f3;">
                        <small style="color: #1976d2; font-weight: 500;">
                            ‚ÑπÔ∏è <strong>Actividades Peri√≥dicas:</strong> Para actividades semanales, mensuales, trimestrales, etc., 
                            usa la pesta√±a <strong style="color: #667eea;">"üìÖ Plan"</strong>
                        </small>
                    </div>
                </div>
                
                <button onclick="saveNewActivity()" class="btn" style="width: 100%; margin-top: 15px;">
                    ‚úì Guardar Actividad
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: AGREGAR SECCI√ìN -->
    <div id="addSectionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚ûï Agregar Nueva Secci√≥n</h3>
                <span class="close" onclick="closeAddSectionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre de la secci√≥n:</label>
                    <input type="text" id="newSectionName" placeholder="Ej: Compresor MYCOM" 
                           style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                </div>
                
                <div class="form-group">
                    <label>Emoji/√çcono:</label>
                    <input type="text" id="newSectionIcon" value="üì¶" 
                           style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                </div>
                
                <div class="form-group">
                    <label>Mostrar en Reporte Diario:</label>
                    <select id="newSectionShowInSummary" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        <option value="no">No mostrar</option>
                        <option value="resumido" selected>Resumido (solo % y actividades)</option>
                        <option value="detalle">Detalle completo (% + valores)</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        <strong>Resumido:</strong> Muestra "Secci√≥n: 4/10 (40%)"<br>
                        <strong>Detalle:</strong> Muestra porcentaje + lista de actividades con valores
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="saveNewSection()" class="btn" style="flex: 1; background: #28a745;">
                        ‚úì Crear Secci√≥n
                    </button>
                    <button onclick="closeAddSectionModal()" class="btn" style="flex: 1; background: #6c757d;">
                        ‚úï Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EDITAR SECCI√ìN -->
    <div id="editSectionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Secci√≥n</h3>
                <span class="close" onclick="closeEditSectionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre de la secci√≥n:</label>
                    <input type="text" id="editSectionName" placeholder="Ej: Compresor MYCOM" 
                           style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                </div>
                
                <div class="form-group">
                    <label>Emoji/√çcono:</label>
                    <input type="text" id="editSectionIcon" 
                           style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                </div>
                
                <div class="form-group">
                    <label>Mostrar en Reporte Diario:</label>
                    <select id="editSectionShowInSummary" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                        <option value="no">No mostrar</option>
                        <option value="resumido">Resumido (solo % y actividades)</option>
                        <option value="detalle">Detalle completo (% + valores)</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        <strong>Resumido:</strong> Muestra "Secci√≥n: 4/10 (40%)"<br>
                        <strong>Detalle:</strong> Muestra porcentaje + lista de actividades con valores
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="saveEditedSection()" class="btn" style="flex: 1; background: #28a745;">
                        ‚úì Guardar Cambios
                    </button>
                    <button onclick="closeEditSectionModal()" class="btn" style="flex: 1; background: #6c757d;">
                        ‚úï Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Actividad Peri√≥dica -->
    <div id="newPlanActivityModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
                <h3 style="margin: 0;">üìÖ Nueva Actividad Peri√≥dica</h3>
                <span class="close" onclick="closeNewPlanActivityModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label><strong>Secci√≥n/Equipo:</strong></label>
                    <select id="planActivitySection" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                        <option value="">Seleccionar secci√≥n...</option>
                        <!-- Se llenar√° din√°micamente -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label><strong>Nombre de la Actividad:</strong></label>
                    <input type="text" id="planActivityName" placeholder="Ej: Cambio de Aceite Motor A" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label><strong>Descripci√≥n Detallada:</strong></label>
                    <textarea id="planActivityDescription" rows="3" 
                              placeholder="Describe el procedimiento completo de la actividad..."
                              style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px; resize: vertical;"></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">Incluye materiales necesarios, pasos a seguir, precauciones, etc.</small>
                </div>
                
                <div class="form-group">
                    <label><strong>Frecuencia:</strong></label>
                    <select id="planActivityFrequency" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                        <option value="">Seleccionar frecuencia...</option>
                        <option value="weekly">üîµ Semanal (cada 7 d√≠as)</option>
                        <option value="biweekly">üü¢ Quincenal (cada 15 d√≠as)</option>
                        <option value="monthly">üü° Mensual (cada 30 d√≠as)</option>
                        <option value="bimonthly">üü† Bimestral (cada 60 d√≠as)</option>
                        <option value="quarterly">üü£ Trimestral (cada 90 d√≠as)</option>
                        <option value="semiannual">üî¥ Semestral (cada 180 d√≠as)</option>
                        <option value="annual">‚ö´ Anual (cada 365 d√≠as)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><strong>Fecha de Primera Ejecuci√≥n:</strong></label>
                    <input type="date" id="planActivityFirstDate" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                    <small style="color: #666; display: block; margin-top: 5px;">A partir de esta fecha, la actividad aparecer√° en el Mantenimiento Preventivo</small>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1976d2;">‚ÑπÔ∏è Importante:</strong>
                    <ul style="margin: 10px 0 0 20px; color: #666; font-size: 13px;">
                        <li>La actividad quedar√° <strong>pendiente de aprobaci√≥n</strong></li>
                        <li>Un supervisor debe aprobarla para activarla</li>
                        <li>Una vez aprobada, aparecer√° autom√°ticamente en su fecha programada</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="savePlanActivity()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 15px; font-weight: bold;">
                        ‚úì Crear Actividad
                    </button>
                    <button onclick="closeNewPlanActivityModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 15px;">
                        ‚úï Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Usuario -->
    <div id="addUserModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3>üë§ Agregar Nuevo Usuario</h3>
                <span class="close" onclick="closeAddUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label><strong>Nombre Completo:</strong></label>
                    <input type="text" id="newUserFullName" placeholder="Ej: Juan P√©rez" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label><strong>Usuario (para login):</strong></label>
                    <input type="text" id="newUserUsername" placeholder="Ej: jperez" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                    <small style="color: #666; display: block; margin-top: 5px;">Sin espacios, letras min√∫sculas y n√∫meros</small>
                </div>
                
                <div class="form-group">
                    <label><strong>Contrase√±a:</strong></label>
                    <input type="password" id="newUserPassword" placeholder="M√≠nimo 6 caracteres" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label><strong>Rol:</strong></label>
                    <select id="newUserRole" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                        <option value="">Seleccionar rol...</option>
                        <option value="admin">Administrador (acceso completo)</option>
                        <option value="supervisor">Supervisor (aprobar actividades)</option>
                        <option value="operador">Operador (solo ejecuci√≥n)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><strong>Permisos de Pesta√±as:</strong></label>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="newUserCanViewReporte" style="margin-right: 8px;">
                            <span>üìä Reporte Diario</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="newUserCanViewMantenimiento" style="margin-right: 8px;">
                            <span>üîß Mantenimiento Preventivo</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="newUserCanViewPlan" style="margin-right: 8px;">
                            <span>üìÖ Plan de Mantenimiento</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="newUserCanViewHistorial" style="margin-right: 8px;">
                            <span>üìã Historial</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="newUserCanViewConfig" style="margin-right: 8px;">
                            <span>‚öôÔ∏è Configuraci√≥n</span>
                        </label>
                    </div>
                    <small style="color: #666; display: block; margin-top: 8px;">Marca las pesta√±as que este usuario podr√° ver</small>
                </div>
                
                <div class="form-group">
                    <label><strong>Permisos Especiales:</strong></label>
                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffc107;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="newUserCanApprovePlan" style="margin-right: 8px;">
                            <span>‚≠ê Puede aprobar actividades peri√≥dicas (Plan)</span>
                        </label>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">Administradores y Supervisores tienen todos los permisos autom√°ticamente</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveNewUser()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 15px; font-weight: bold;">
                        ‚úì Crear Usuario
                    </button>
                    <button onclick="closeAddUserModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 15px;">
                        ‚úï Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Usuario -->
    <div id="editUserModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Usuario</h3>
                <span class="close" onclick="closeEditUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label><strong>Nombre Completo:</strong></label>
                    <input type="text" id="editUserFullName" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label><strong>Usuario (para login):</strong></label>
                    <input type="text" id="editUserUsername" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label><strong>Nueva Contrase√±a:</strong></label>
                    <input type="password" id="editUserPassword" placeholder="Dejar vac√≠o para no cambiar" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                    <small style="color: #666; display: block; margin-top: 5px;">Solo completa si quieres cambiar la contrase√±a</small>
                </div>
                
                <div class="form-group">
                    <label><strong>Rol:</strong></label>
                    <select id="editUserRole" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
                        <option value="admin">Administrador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="operador">Operador</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><strong>Permisos de Pesta√±as:</strong></label>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="editUserCanViewReporte" style="margin-right: 8px;">
                            <span>üìä Reporte Diario</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="editUserCanViewMantenimiento" style="margin-right: 8px;">
                            <span>üîß Mantenimiento Preventivo</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="editUserCanViewPlan" style="margin-right: 8px;">
                            <span>üìÖ Plan de Mantenimiento</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="editUserCanViewHistorial" style="margin-right: 8px;">
                            <span>üìã Historial</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="editUserCanViewConfig" style="margin-right: 8px;">
                            <span>‚öôÔ∏è Configuraci√≥n</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><strong>Permisos Especiales:</strong></label>
                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffc107;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="editUserCanApprovePlan" style="margin-right: 8px;">
                            <span>‚≠ê Puede aprobar actividades peri√≥dicas (Plan)</span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveEditedUser()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 15px; font-weight: bold;">
                        ‚úì Guardar Cambios
                    </button>
                    <button onclick="closeEditUserModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 15px;">
                        ‚úï Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        
        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                if (typeof firebase !== 'undefined') {
                    console.log('‚úÖ Firebase ya est√° disponible');
                    resolve();
                } else {
                    console.log('‚è≥ Esperando a que Firebase se cargue...');
                    let attempts = 0;
                    const checkFirebase = setInterval(() => {
                        attempts++;
                        console.log(`Intento ${attempts}/100 de cargar Firebase...`);
                        if (typeof firebase !== 'undefined') {
                            clearInterval(checkFirebase);
                            console.log('‚úÖ Firebase cargado exitosamente');
                            resolve();
                        } else if (attempts > 100) { // 10 segundos
                            clearInterval(checkFirebase);
                            console.error('‚ùå Firebase no se pudo cargar despu√©s de 10 segundos');
                            reject(new Error('Firebase no se pudo cargar. Verifica tu conexi√≥n a internet.'));
                        }
                    }, 100);
                }
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCTMEffJZejx03s5ImhcP7CBPX5cPAv-2M",
            authDomain: "hsb-app-784ba.firebaseapp.com",
            databaseURL: "https://hsb-app-784ba-default-rtdb.firebaseio.com",
            projectId: "hsb-app-784ba",
            storageBucket: "hsb-app-784ba.firebasestorage.app",
            messagingSenderId: "493517988093",
            appId: "1:493517988093:web:b936886501451f47de1e94",
            measurementId: "G-HN6K1ZZN32"
        };

        let database;
        let storage;

        async function initializeFirebase() {
            try {
                await waitForFirebase();
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                storage = firebase.storage();
                initializeRefs(); // Initialize database references
                console.log('üî• Firebase initialized successfully!');
                return true;
            } catch (error) {
                console.error('‚ùå Error loading Firebase:', error);
                return false;
            }
        }

        // ==================== GLOBAL VARIABLES ====================
        
        let currentUser = null;
        let currentSectionId = null;
        
        // Funci√≥n para obtener la fecha operacional (d√≠a comienza a las 6:00 AM)
        function getOperationalDate() {
            const now = new Date();
            const hour = now.getHours();
            
            // Si son antes de las 06:00 AM, usar el d√≠a anterior
            if (hour < 6) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                return yesterday.toISOString().split('T')[0];
            }
            
            return now.toISOString().split('T')[0];
        }
        
        let currentDate = getOperationalDate();
        let accumulatedPhotos = []; // Para acumular fotos en m√≥vil

        // Firebase references (will be initialized after Firebase loads)
        let usersRef;
        let tabsRef;
        let sectionsRef;
        let activitiesRef;
        let novedadesPredefinidasRef;
        let dailyLogsRef;
        let planActivitiesRef;
        let planExecutionsRef;
        let notCompletedActivitiesRef;
        let alertsRef;
        let novedadesRef;

        function initializeRefs() {
            usersRef = database.ref('users');
            tabsRef = database.ref('tabs');
            sectionsRef = database.ref('sections');
            activitiesRef = database.ref('activities');
            novedadesPredefinidasRef = database.ref('novedadesPredefinidas');
            dailyLogsRef = database.ref('dailyLogs');
            planActivitiesRef = database.ref('planActivities');
            planExecutionsRef = database.ref('planExecutions');
            notCompletedActivitiesRef = database.ref('notCompletedActivities');
            alertsRef = database.ref('alerts');
            novedadesRef = database.ref('novedades');
        }

        // Local cache
        let users = [];
        let tabs = [];
        let sections = [];
        let activities = [];
        let novedadesPredefinidas = [];
        let dailyLogs = {};
        let planActivities = {};  // Cambiar de [] a {}
        let planExecutions = {};
        let notCompletedActivities = {};
        let alerts = [];
        let novedades = {};
        
        // Exponer variables al scope global para funciones window.*
        window.HSB_DATA = {
            get sections() { return sections; },
            get activities() { return activities; },
            get dailyLogs() { return dailyLogs; },
            get planActivities() { return planActivities; },
            get novedades() { return novedades; },
            get currentDate() { return currentDate; },
            get currentSectionId() { return currentSectionId; }
        };

        // ==================== FIREBASE HELPERS ====================
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showSyncIndicator(message, type = 'syncing') {
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = message;
            indicator.className = 'sync-indicator ' + type;
            setTimeout(() => {
                indicator.className = 'sync-indicator';
            }, 2000);
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }
        
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('es-ES', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // ==================== DEFAULT DATA ====================
        
        const defaultUsers = [
            { 
                id: 1, 
                username: 'admin', 
                password: 'admin123', 
                fullName: 'Administrador',
                role: 'admin',
                permissions: ['reporte-diario', 'mantenimiento-preventivo', 'plan', 'historial', 'configuracion'],
                planPermissions: {
                    canView: true,
                    canApprove: true
                }
            },
            { 
                id: 2, 
                username: 'supervisor', 
                password: 'super123', 
                fullName: 'Supervisor',
                role: 'supervisor',
                permissions: ['reporte-diario', 'mantenimiento-preventivo', 'plan', 'historial'],
                planPermissions: {
                    canView: true,
                    canApprove: true
                }
            },
            { 
                id: 3, 
                username: 'operador', 
                password: 'operador123', 
                fullName: 'Operador General',
                role: 'operador',
                permissions: ['mantenimiento-preventivo', 'reporte-diario'],
                planPermissions: {
                    canView: false,
                    canApprove: false
                }
            }
        ];

        const defaultTabs = [
            { id: 'reporte-diario', name: 'üìä Reporte Diario', order: 1 },
            { id: 'mantenimiento-preventivo', name: 'üîß Mantenimiento Preventivo', order: 2 },
            { id: 'plan', name: 'üìÖ Plan', order: 3 },
            { id: 'historial', name: 'üìã Historial', order: 4 },
            { id: 'configuracion', name: '‚öôÔ∏è Configuraci√≥n', order: 5 }
        ];

        const defaultSections = [
            { id: 1, name: 'Par√°metros Generales', icon: 'üìä', order: 1 },
            { id: 2, name: 'Compresor MYCOM', icon: 'üîµ', order: 2 },
            { id: 3, name: 'Compresor VILTER', icon: 'üü¢', order: 3 }
        ];

        const defaultActivities = [
            { id: 1, sectionId: 1, name: 'Temperatura Cuba', type: 'parametros', unit: '¬∞C', min: -15, max: -12, frequency: '2 veces al dia', showInSummary: 'detalle', order: 1 },
            { id: 2, sectionId: 1, name: 'Densidad', type: 'parametros', unit: '%', min: 70, max: 80, frequency: '2 veces al dia', showInSummary: 'detalle', order: 2 },
            { id: 3, sectionId: 2, name: 'Descarga', type: 'parametros', unit: 'PSI', min: 180, max: 220, frequency: '2 veces al dia', showInSummary: 'detalle', order: 1 },
            { id: 4, sectionId: 2, name: 'Succi√≥n', type: 'parametros', unit: 'PSI', min: 8, max: 18, frequency: '2 veces al dia', showInSummary: 'detalle', order: 2 },
            { id: 5, sectionId: 2, name: 'Amperaje', type: 'parametros', unit: 'A', min: 60, max: 75, frequency: '2 veces al dia', showInSummary: 'detalle', order: 3 },
            { id: 6, sectionId: 2, name: 'Nivel de Aceite', type: 'chequeo', frequency: '2 veces al dia', showInSummary: 'estado', order: 4 },
            { id: 7, sectionId: 2, name: 'Capacidad', type: 'parametros', unit: '%', min: 0, max: 100, frequency: '2 veces al dia', showInSummary: 'detalle', order: 5 },
            { id: 8, sectionId: 3, name: 'Descarga', type: 'parametros', unit: 'PSI', min: 170, max: 200, frequency: '2 veces al dia', showInSummary: 'detalle', order: 1 },
            { id: 9, sectionId: 3, name: 'Succi√≥n', type: 'parametros', unit: 'PSI', min: 5, max: 15, frequency: '2 veces al dia', showInSummary: 'detalle', order: 2 },
            { id: 10, sectionId: 3, name: 'Amperaje', type: 'parametros', unit: 'A', min: 45, max: 85, frequency: '2 veces al dia', showInSummary: 'detalle', order: 3 },
            { id: 11, sectionId: 3, name: 'Nivel de Aceite', type: 'chequeo', frequency: '2 veces al dia', showInSummary: 'estado', order: 4 },
            { id: 12, sectionId: 3, name: 'Capacidad', type: 'parametros', unit: '%', min: 0, max: 100, frequency: '2 veces al dia', showInSummary: 'detalle', order: 5 },
            // Actividades peri√≥dicas para el Plan
            { id: 13, sectionId: 2, name: 'Limpieza de Filtros', type: 'chequeo', frequency: 'Semanal', showInSummary: 'estado', order: 6 },
            { id: 14, sectionId: 2, name: 'Inspecci√≥n General Compresor', type: 'chequeo', frequency: 'Semanal', showInSummary: 'estado', order: 7 },
            { id: 15, sectionId: 3, name: 'Revisi√≥n de Conexiones El√©ctricas', type: 'chequeo', frequency: 'Mensual', showInSummary: 'estado', order: 6 },
            { id: 16, sectionId: 2, name: 'Cambio de Aceite', type: 'chequeo', frequency: 'Mensual', showInSummary: 'estado', order: 8 },
            { id: 17, sectionId: 2, name: 'Mantenimiento Preventivo Completo', type: 'chequeo', frequency: 'Trimestral', showInSummary: 'estado', order: 9 },
            { id: 18, sectionId: 3, name: 'Calibraci√≥n de Instrumentos', type: 'chequeo', frequency: 'Trimestral', showInSummary: 'estado', order: 7 }
        ];

        const defaultNovedades = [
            { id: 1, text: 'Lluvia' },
            { id: 2, text: 'Sin Luz' },
            { id: 3, text: 'Falla de Equipos' }
        ];

        // ==================== INITIALIZE FIREBASE DATA ====================
        
        async function initializeFirebaseData() {
            console.log('üîÑ Initializing Firebase data...');

            try {
                const usersSnapshot = await usersRef.once('value');
                
                if (!usersSnapshot.exists()) {
                    console.log('üìù Creating default data...');
                    await Promise.all([
                        usersRef.set(defaultUsers),
                        tabsRef.set(defaultTabs),
                        sectionsRef.set(defaultSections),
                        activitiesRef.set(defaultActivities),
                        novedadesPredefinidasRef.set(defaultNovedades),
                        dailyLogsRef.set({}),
                        planActivitiesRef.set([])
                    ]);
                    console.log('‚úÖ Default data created!');
                }

                await loadDataFromFirebase();
                
                // Mostrar formulario de login cuando los datos est√©n listos
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                
                console.log('‚úÖ Firebase ready - Login enabled');
                showSyncIndicator('‚úì Listo para usar', 'synced');
            } catch (error) {
                console.error('‚ùå Error initializing Firebase:', error);
                document.getElementById('loginLoading').innerHTML = `
                    <p style="color: #dc3545;">‚ùå Error al conectar con Firebase</p>
                    <p style="font-size: 12px;">${error.message}</p>
                    <button onclick="location.reload()" class="btn" style="margin-top: 15px;">üîÑ Reintentar</button>
                `;
            }
        }

        async function loadDataFromFirebase() {
            console.log('üì• Loading data from Firebase...');

            try {
                const [usersSnap, tabsSnap, sectionsSnap, activitiesSnap, novedadesSnap, logsSnap, planSnap, planExecSnap, notCompletedSnap, alertsSnap, novedadesFullSnap] = await Promise.all([
                    usersRef.once('value'),
                    tabsRef.once('value'),
                    sectionsRef.once('value'),
                    activitiesRef.once('value'),
                    novedadesPredefinidasRef.once('value'),
                    dailyLogsRef.once('value'),
                    planActivitiesRef.once('value'),
                    planExecutionsRef.once('value'),
                    notCompletedActivitiesRef.once('value'),
                    alertsRef.once('value'),
                    novedadesRef.once('value')
                ]);

                users = usersSnap.val() || [];
                tabs = tabsSnap.val() || [];
                sections = sectionsSnap.val() || [];
                activities = activitiesSnap.val() || [];
                novedadesPredefinidas = novedadesSnap.val() || [];
                dailyLogs = logsSnap.val() || {};
                planActivities = planSnap.val() || {};  // Cambiar de [] a {}
                planExecutions = planExecSnap.val() || {};
                notCompletedActivities = notCompletedSnap.val() || {};
                alerts = alertsSnap.val() ? Object.values(alertsSnap.val()) : [];
                novedades = novedadesFullSnap.val() || {};

                console.log('‚úÖ Data loaded successfully!');
                console.log(`üìä Loaded: ${users.length} users, ${sections.length} sections, ${activities.length} activities`);
                console.log(`üìã Alertas: ${alerts.length}, Actividades no realizadas en ${Object.keys(notCompletedActivities).length} d√≠as`);
                
                // Reparar dailyLogs con secciones faltantes
                await repairDailyLogs();
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
            }
        }
        
        async function repairDailyLogs() {
            console.log('üîß Reparando dailyLogs con secciones faltantes...');
            
            let repaired = false;
            
            // Para cada d√≠a en dailyLogs
            for (const [date, log] of Object.entries(dailyLogs)) {
                if (!log.sections) {
                    log.sections = {};
                }
                
                // Para cada secci√≥n actual del sistema
                sections.forEach(section => {
                    // Si esta secci√≥n no existe en este d√≠a, agregarla
                    if (!log.sections[section.id]) {
                        console.log(`  ‚ûï Agregando secci√≥n "${section.name}" (id:${section.id}) al d√≠a ${date}`);
                        
                        log.sections[section.id] = {
                            activities: {},
                            photos: []
                        };
                        
                        // Agregar actividades de esta secci√≥n
                        const sectionActivities = activities.filter(a => a.sectionId === section.id);
                        sectionActivities.forEach(activity => {
                            if (activity.frequency === '2 veces al dia') {
                                log.sections[section.id].activities[`${activity.id}_manana`] = {
                                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                                };
                                log.sections[section.id].activities[`${activity.id}_tarde`] = {
                                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                                };
                            } else if (activity.frequency === 'Diario') {
                                log.sections[section.id].activities[activity.id] = {
                                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                                };
                            }
                        });
                        
                        repaired = true;
                    }
                });
            }
            
            // Si se repar√≥ algo, guardar en Firebase
            if (repaired) {
                await dailyLogsRef.set(dailyLogs);
                console.log('‚úÖ DailyLogs reparados y guardados');
            } else {
                console.log('‚úÖ DailyLogs est√°n completos');
            }
        }

        // ==================== REAL-TIME SYNC ====================
        
        function setupRealTimeSync() {
            console.log('üîÑ Setting up real-time sync...');

            dailyLogsRef.on('value', (snapshot) => {
                const previousLogs = JSON.stringify(dailyLogs);
                dailyLogs = snapshot.val() || {};
                const newLogs = JSON.stringify(dailyLogs);
                
                // Solo re-renderizar si hubo cambios reales
                if (previousLogs !== newLogs) {
                    console.log('üîÑ Daily logs updated - refreshing views');
                    
                    // Actualizar vista de Mantenimiento Preventivo
                    if (document.getElementById('tab-mantenimiento-preventivo').classList.contains('active')) {
                        const detailActive = document.getElementById('sectionDetail').classList.contains('active');
                        if (!detailActive) {
                            renderSections();
                        }
                    }
                    
                    // Actualizar vista de Reporte Diario
                    if (document.getElementById('tab-reporte-diario').classList.contains('active')) {
                        renderReporteDiario();
                        console.log('üìä Reporte Diario actualizado autom√°ticamente');
                    }
                    
                    showSyncIndicator('‚úì Datos actualizados', 'synced');
                } else {
                    console.log('üîÑ Sync check - no changes');
                }
            });
            
            // Listener para Plan de Mantenimiento
            planActivitiesRef.on('value', (snapshot) => {
                planActivities = snapshot.val() || {};
                console.log('üìÖ Plan activities updated');
                
                // Actualizar vista de Plan si est√° activa
                if (document.getElementById('tab-plan').classList.contains('active')) {
                    renderPlan();
                }
            });

            console.log('‚úÖ Real-time sync active!');
        }
        
        // ==================== PLAN DE MANTENIMIENTO ====================
        
        let planFilterSection = 'all'; // Variable global para filtro
        
        function renderPlanFilter() {
            let html = `
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="font-weight: bold; color: #1e3c72;">üîç Filtrar por Secci√≥n:</label>
                        <select id="planSectionFilter" onchange="filterPlanBySection(this.value)" 
                                style="flex: 1; max-width: 400px; padding: 10px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px;">
                            <option value="all">üìã Todas las Secciones</option>
            `;
            
            sections.forEach(section => {
                const selected = planFilterSection == section.id ? 'selected' : '';
                html += `<option value="${section.id}" ${selected}>${section.icon} ${section.name}</option>`;
            });
            
            html += `
                        </select>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function filterPlanBySection(sectionId) {
            planFilterSection = sectionId;
            renderPlan();
        }
        
        function openNewPlanActivityModal() {
            // Llenar selector de secciones
            const sectionSelect = document.getElementById('planActivitySection');
            sectionSelect.innerHTML = '<option value="">Seleccionar secci√≥n...</option>';
            sections.forEach(section => {
                sectionSelect.innerHTML += `<option value="${section.id}">${section.icon} ${section.name}</option>`;
            });
            
            // Establecer fecha m√≠nima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planActivityFirstDate').setAttribute('min', today);
            document.getElementById('planActivityFirstDate').value = today;
            
            // Mostrar modal
            document.getElementById('newPlanActivityModal').style.display = 'block';
        }
        
        function closeNewPlanActivityModal() {
            document.getElementById('newPlanActivityModal').style.display = 'none';
            // Limpiar campos
            document.getElementById('planActivitySection').value = '';
            document.getElementById('planActivityName').value = '';
            document.getElementById('planActivityDescription').value = '';
            document.getElementById('planActivityFrequency').value = '';
            document.getElementById('planActivityFirstDate').value = '';
        }
        
        async function savePlanActivity() {
            const sectionId = document.getElementById('planActivitySection').value;
            const name = document.getElementById('planActivityName').value.trim();
            const description = document.getElementById('planActivityDescription').value.trim();
            const frequency = document.getElementById('planActivityFrequency').value;
            const firstDate = document.getElementById('planActivityFirstDate').value;
            
            // Validaciones
            if (!sectionId) {
                alert('‚ö†Ô∏è Debes seleccionar una secci√≥n');
                return;
            }
            
            if (!name) {
                alert('‚ö†Ô∏è Debes ingresar el nombre de la actividad');
                return;
            }
            
            if (!frequency) {
                alert('‚ö†Ô∏è Debes seleccionar la frecuencia');
                return;
            }
            
            if (!firstDate) {
                alert('‚ö†Ô∏è Debes ingresar la fecha de primera ejecuci√≥n');
                return;
            }
            
            const frequencyDays = {
                'weekly': 7,
                'biweekly': 15,
                'monthly': 30,
                'bimonthly': 60,
                'quarterly': 90,
                'semiannual': 180,
                'annual': 365
            };
            
            const newActivity = {
                id: Date.now(),
                sectionId: parseInt(sectionId),
                name: name,
                description: description || 'Sin descripci√≥n',
                frequency: frequency,
                frequencyDays: frequencyDays[frequency],
                status: 'pending',  // Pendiente de aprobaci√≥n
                firstExecution: firstDate,
                lastExecution: null,
                nextExecution: firstDate,
                daysOverdue: 0,
                active: false,
                createdBy: currentUser.fullName,
                createdDate: new Date().toISOString().split('T')[0],
                approvedBy: null,
                approvedDate: null
            };
            
            try {
                showSyncIndicator('üíæ Guardando actividad...', 'syncing');
                
                await planActivitiesRef.push(newActivity);
                
                showSyncIndicator('‚úì Actividad creada (pendiente de aprobaci√≥n)', 'synced');
                closeNewPlanActivityModal();
                renderPlan();
                
            } catch (error) {
                console.error('Error al crear actividad:', error);
                showSyncIndicator('‚úó Error al crear', 'error');
            }
        }
        
        function renderPlan() {
            const container = document.getElementById('planContent');
            
            if (!planActivities || Object.keys(planActivities).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìÖ</div>
                        <h3 style="color: #666; margin-bottom: 10px;">No hay actividades en el plan</h3>
                        <p style="color: #999; font-size: 14px;">Crea tu primera actividad peri√≥dica para comenzar</p>
                    </div>
                `;
                return;
            }
            
            // Convertir objeto a array
            let activitiesArray = Object.entries(planActivities).map(([key, activity]) => ({
                firebaseKey: key,
                ...activity
            }));
            
            // Aplicar filtro por secci√≥n
            if (planFilterSection !== 'all') {
                activitiesArray = activitiesArray.filter(a => a.sectionId === parseInt(planFilterSection));
            }
            
            // Si despu√©s del filtro no hay actividades
            if (activitiesArray.length === 0) {
                container.innerHTML = `
                    ${renderPlanFilter()}
                    <div style="text-align: center; padding: 40px 20px; background: white; margin-top: 15px; border-radius: 8px;">
                        <p style="color: #999;">No hay actividades para la secci√≥n seleccionada</p>
                    </div>
                `;
                return;
            }
            
            // Tabla estilo lista
            let html = renderPlanFilter() + `
                <div style="overflow-x: auto; margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Equipo/√Årea</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Acci√≥n</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ddd;">Frecuencia</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ddd;">√öltima Ejecuci√≥n</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ddd;">Pr√≥xima Ejecuci√≥n</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ddd;">Estatus</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ddd;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            activitiesArray.forEach(activity => {
                const section = sections.find(s => s.id === activity.sectionId);
                const sectionName = section ? `${section.icon} ${section.name}` : 'Sin secci√≥n';
                const frequencyLabel = getFrequencyLabel(activity.frequency);
                
                const lastExec = activity.lastExecution ? formatDateShort(activity.lastExecution) : '-';
                const nextExec = activity.nextExecution ? formatDateShort(activity.nextExecution) : formatDateShort(activity.firstExecution);
                
                // Determinar estatus
                let statusBadge = '';
                let rowBg = 'white';
                
                if (activity.status === 'pending') {
                    statusBadge = '<span style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">‚è≥ Pendiente</span>';
                    rowBg = '#f8f9fa';
                } else if (activity.status === 'overdue') {
                    const daysOverdue = calculateDaysOverdue(activity.nextExecution);
                    statusBadge = `<span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üî¥ Vencida (${daysOverdue}d)</span>`;
                    rowBg = '#ffe6e6';
                } else if (isUpcoming(activity)) {
                    const daysUntil = calculateDaysUntil(activity.nextExecution);
                    statusBadge = `<span style="background: #ffc107; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üü° Pr√≥xima (${daysUntil}d)</span>`;
                    rowBg = '#fff8e6';
                } else {
                    statusBadge = '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üü¢ Al d√≠a</span>';
                }
                
                // Botones de acci√≥n
                let actionButtons = '';
                const canApprove = currentUser.role === 'admin' || currentUser.role === 'supervisor' || 
                                 (currentUser.planPermissions && currentUser.planPermissions.canApprove);
                
                if (activity.status === 'pending' && canApprove) {
                    actionButtons = `
                        <button onclick="approvePlanActivity('${activity.firebaseKey}')" 
                                style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                            ‚úì Aprobar
                        </button>
                        <button onclick="deletePlanActivity('${activity.firebaseKey}')" 
                                style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                            üóëÔ∏è Eliminar
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button onclick="viewPlanHistory('${activity.firebaseKey}')" 
                                style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                            üìä Historial
                        </button>
                    `;
                }
                
                html += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">${sectionName}</td>
                        <td style="padding: 12px;">
                            <strong>${activity.name}</strong>
                            ${activity.description ? `<br><small style="color: #666;">${activity.description}</small>` : ''}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                                ${frequencyLabel}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">${lastExec}</td>
                        <td style="padding: 12px; text-align: center;">${nextExec}</td>
                        <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                        <td style="padding: 12px; text-align: center;">${actionButtons}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        
        function getFrequencyLabel(frequency) {
            const labels = {
                'weekly': 'Semanal',
                'biweekly': 'Quincenal',
                'monthly': 'Mensual',
                'bimonthly': 'Bimestral',
                'quarterly': 'Trimestral',
                'semiannual': 'Semestral',
                'annual': 'Anual'
            };
            return labels[frequency] || frequency;
        }
        
        function isUpcoming(activity) {
            const daysUntil = calculateDaysUntil(activity.nextExecution);
            return daysUntil >= 0 && daysUntil <= 7;
        }
        
        function calculateDaysUntil(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateStr);
            targetDate.setHours(0, 0, 0, 0);
            const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function calculateDaysOverdue(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateStr);
            targetDate.setHours(0, 0, 0, 0);
            const diff = Math.ceil((today - targetDate) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
        }
        
        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        async function approvePlanActivity(firebaseKey) {
            const activity = planActivities[firebaseKey];
            
            if (!confirm(`¬øAprobar la actividad "${activity.name}"?\n\nEsto la agregar√° al plan de mantenimiento activo.`)) {
                return;
            }
            
            try {
                showSyncIndicator('‚öôÔ∏è Aprobando actividad...', 'syncing');
                
                await planActivitiesRef.child(firebaseKey).update({
                    status: 'approved',
                    active: true,
                    approvedBy: currentUser.fullName,
                    approvedDate: new Date().toISOString().split('T')[0]
                });
                
                showSyncIndicator('‚úì Actividad aprobada', 'synced');
                
            } catch (error) {
                console.error('Error al aprobar:', error);
                showSyncIndicator('‚úó Error al aprobar', 'error');
            }
        }
        
        async function deletePlanActivity(firebaseKey) {
            const activity = planActivities[firebaseKey];
            
            if (!confirm(`¬øEliminar la actividad "${activity.name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                showSyncIndicator('üóëÔ∏è Eliminando...', 'syncing');
                
                await planActivitiesRef.child(firebaseKey).remove();
                
                showSyncIndicator('‚úì Actividad eliminada', 'synced');
                
            } catch (error) {
                console.error('Error al eliminar:', error);
                showSyncIndicator('‚úó Error al eliminar', 'error');
            }
        }
        
        function viewPlanHistory(firebaseKey) {
            alert('Funci√≥n de historial en desarrollo (FASE 5)');
        }

        // ==================== AUTHENTICATION ====================
        
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('üîê Login attempt...');
            console.log('Users loaded:', users.length);
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (users.length === 0) {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = '‚ö†Ô∏è Datos a√∫n cargando, intenta nuevamente';
                errorDiv.style.display = 'block';
                return;
            }
            
            const user = users.find(u => u.username === username && u.password === password);
            
            console.log('User found:', user ? user.username : 'NOT FOUND');
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainScreen();
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = '‚ùå Usuario o contrase√±a incorrectos';
                errorDiv.style.display = 'block';
            }
        });

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = 
                currentUser.role === 'admin' ? 'Administrador' : 
                currentUser.role === 'supervisor' ? 'Supervisor' : 'Operador';
            
            renderTabs();
            initializeDailyLog();
            
            // Iniciar reloj del sistema con peque√±o delay para asegurar DOM
            setTimeout(() => {
                startSystemClock();
            }, 100);
        }

        // ==================== TABS ====================
        
        function renderTabs() {
            const tabsContainer = document.getElementById('mainTabs');
            tabsContainer.innerHTML = '';
            
            const userTabs = tabs
                .filter(tab => currentUser.permissions.includes(tab.id))
                .sort((a, b) => a.order - b.order);
            
            userTabs.forEach((tab, index) => {
                const tabButton = document.createElement('button');
                tabButton.className = 'tab' + (index === 0 ? ' active' : '');
                tabButton.textContent = tab.name;
                tabButton.onclick = function() { showTab(tab.id, this); };
                tabsContainer.appendChild(tabButton);
                
                const tabContent = document.getElementById(`tab-${tab.id}`);
                if (tabContent) {
                    tabContent.classList.toggle('active', index === 0);
                }
            });

            if (userTabs.length > 0) {
                showTab(userTabs[0].id);
            }
        }

        function showTab(tabId, targetButton) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (tabContent) {
                tabContent.classList.add('active');
                
                if (tabId === 'mantenimiento-preventivo') {
                    renderSections();
                } else if (tabId === 'plan') {
                    renderPlan();
                    // Mostrar bot√≥n para Admin y Supervisor siempre
                    const btnNewActivity = document.getElementById('btnNewPlanActivity');
                    if (btnNewActivity) {
                        const canCreate = currentUser.role === 'admin' || 
                                        currentUser.role === 'supervisor' ||
                                        (currentUser.planPermissions && currentUser.planPermissions.canApprove);
                        btnNewActivity.style.display = canCreate ? 'block' : 'none';
                    }
                } else if (tabId === 'reporte-diario') {
                    renderReporteDiario();
                } else if (tabId === 'historial') {
                    renderHistorial();
                } else if (tabId === 'configuracion') {
                    renderConfiguracion();
                }
            }
        }

        // ==================== DAILY LOG ====================
        
        async function initializeDailyLog() {
            if (!dailyLogs[currentDate]) {
                console.log('Creating new daily log for', currentDate);
                
                const newLog = {
                    date: currentDate,
                    sections: {},
                    novedades: []
                };
                
                sections.forEach(section => {
                    newLog.sections[section.id] = {
                        activities: {},
                        photos: []
                    };
                    
                    const sectionActivities = activities.filter(a => a.sectionId === section.id);
                    sectionActivities.forEach(activity => {
                        if (activity.frequency === '2 veces al dia') {
                            newLog.sections[section.id].activities[`${activity.id}_manana`] = {
                                value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                            };
                            newLog.sections[section.id].activities[`${activity.id}_tarde`] = {
                                value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                            };
                        } else if (activity.frequency === 'Diario') {
                            newLog.sections[section.id].activities[activity.id] = {
                                value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                            };
                        }
                    });
                });
                
                await dailyLogsRef.child(currentDate).set(newLog);
                dailyLogs[currentDate] = newLog;
                console.log('‚úÖ Daily log created!');
            }
        }

        // ==================== RENDER SECTIONS ====================
        
        function renderSections() {
            console.log('=== RENDERING SECTIONS ===');
            
            const container = document.getElementById('sectionsContainer');
            if (!container) {
                console.error('Container not found!');
                return;
            }

            container.innerHTML = '';
            
            // Actualizar fecha operacional
            const dateDisplay = document.getElementById('currentDateDisplay');
            if (dateDisplay) {
                const dateObj = new Date(currentDate + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                dateDisplay.textContent = `üìÖ ${formattedDate}`;
            }

            if (!dailyLogs[currentDate]) {
                console.error('No daily log for current date!');
                container.innerHTML = '<p>Inicializando datos...</p>';
                return;
            }

            // Ordenar secciones por campo 'order'
            const sortedSections = [...sections].sort((a, b) => a.order - b.order);
            
            console.log('üìä Secciones a renderizar:', sortedSections.length);
            sortedSections.forEach(s => console.log(`  - ${s.order}: ${s.name}`));

            sortedSections.forEach(section => {
                // Verificar que la secci√≥n existe en el dailyLog
                if (!dailyLogs[currentDate].sections[section.id]) {
                    console.warn(`‚ö†Ô∏è Secci√≥n ${section.name} (id:${section.id}) no existe en dailyLog. Skipping.`);
                    return; // Skip esta secci√≥n
                }
                
                let totalFields = 0;
                let completedFields = 0;

                const sectionActivities = activities.filter(a => a.sectionId === section.id);
                
                sectionActivities.forEach(activity => {
                    if (activity.frequency === '2 veces al dia') {
                        totalFields += 2;
                        const activityDataMorning = dailyLogs[currentDate].sections[section.id].activities[`${activity.id}_manana`];
                        const activityDataAfternoon = dailyLogs[currentDate].sections[section.id].activities[`${activity.id}_tarde`];
                        
                        if (activity.type === 'parametros') {
                            // Cuenta como completado si tiene CUALQUIER valor v√°lido (incluso fuera de rango)
                            if (activityDataMorning && activityDataMorning.value !== null && activityDataMorning.value !== undefined && activityDataMorning.value !== '' && !isNaN(activityDataMorning.value)) {
                                completedFields++;
                            }
                            if (activityDataAfternoon && activityDataAfternoon.value !== null && activityDataAfternoon.value !== undefined && activityDataAfternoon.value !== '' && !isNaN(activityDataAfternoon.value)) {
                                completedFields++;
                            }
                        } else if (activity.type === 'nivel_aceite') {
                            // Para nivel de aceite, cuenta si tiene oilLevel seleccionado
                            if (activityDataMorning && activityDataMorning.oilLevel) completedFields++;
                            if (activityDataAfternoon && activityDataAfternoon.oilLevel) completedFields++;
                        } else {
                            // Para chequeos, solo cuenta si est√° marcado como OK
                            if (activityDataMorning && activityDataMorning.status === 'ok') completedFields++;
                            if (activityDataAfternoon && activityDataAfternoon.status === 'ok') completedFields++;
                        }
                    } else if (activity.frequency === 'Diario') {
                        totalFields += 1;
                        const activityData = dailyLogs[currentDate].sections[section.id].activities[activity.id];
                        
                        if (activity.type === 'parametros') {
                            // Cuenta como completado si tiene CUALQUIER valor v√°lido (incluso fuera de rango)
                            if (activityData && activityData.value !== null && activityData.value !== undefined && activityData.value !== '' && !isNaN(activityData.value)) {
                                completedFields++;
                            }
                        } else if (activity.type === 'nivel_aceite') {
                            // Para nivel de aceite, cuenta si tiene oilLevel seleccionado
                            if (activityData && activityData.oilLevel) completedFields++;
                        } else {
                            // Para chequeos, solo cuenta si est√° marcado como OK
                            if (activityData && activityData.status === 'ok') completedFields++;
                        }
                    }
                });
                
                const percentage = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;
                
                const sectionCard = document.createElement('div');
                sectionCard.className = 'section-card';
                sectionCard.onclick = () => showSectionDetail(section.id);
                sectionCard.innerHTML = `
                    <div class="section-info">
                        <h3>${section.icon} ${section.name}</h3>
                        <div class="section-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                            <div class="progress-text">${percentage}% (${completedFields}/${totalFields})</div>
                        </div>
                    </div>
                    <div class="section-icon">${section.icon}</div>
                `;
                container.appendChild(sectionCard);
            });

            // Secci√≥n de Novedades
            const novedadesCount = (dailyLogs[currentDate] && dailyLogs[currentDate].novedades) ? dailyLogs[currentDate].novedades.length : 0;
            const novedadesCard = document.createElement('div');
            novedadesCard.className = 'section-card';
            novedadesCard.onclick = () => openReportNovedadModal();
            novedadesCard.innerHTML = `
                <div class="section-info">
                    <h3>üìù Novedades</h3>
                    <p style="font-size: 13px; color: #666; margin-top: 5px;">${novedadesCount} novedad(es) reportada(s)</p>
                </div>
                <div class="section-icon">üìù</div>
            `;
            container.appendChild(novedadesCard);
            
            console.log('=== SECTIONS RENDERED ===');
        }

        function showSectionDetail(sectionId) {
            console.log('=== SHOWING SECTION DETAIL ===', sectionId);
            
            currentSectionId = sectionId;
            const section = sections.find(s => s.id === sectionId);
            
            if (!section) {
                console.error('Section not found!');
                return;
            }
            
            document.getElementById('sectionsList').style.display = 'none';
            document.getElementById('sectionDetail').classList.add('active');
            document.getElementById('sectionDetailTitle').textContent = `${section.icon} ${section.name}`;
            
            const content = document.getElementById('sectionDetailContent');
            content.innerHTML = '';
            
            const sectionActivities = activities
                .filter(a => a.sectionId === sectionId && (a.frequency === '2 veces al dia' || a.frequency === 'Diario'))
                .sort((a, b) => a.order - b.order);
            
            console.log('Section activities:', sectionActivities.length);
            
            // ===== ACTIVIDADES PERI√ìDICAS APROBADAS =====
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç BUSCANDO ACTIVIDADES PERI√ìDICAS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìç Secci√≥n actual:', sectionId, section ? `(${section.name})` : '');
            console.log('üìÖ Fecha actual (currentDate):', currentDate);
            console.log('üì¶ planActivities:', planActivities);
            console.log('üìä Tipo de planActivities:', typeof planActivities, Array.isArray(planActivities) ? 'Array' : 'Object');
            console.log('üìà Cantidad total de actividades en plan:', Object.keys(planActivities || {}).length);
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            
            const periodicActivities = Object.entries(planActivities || {})
                .map(([key, activity]) => {
                    console.log(`\nüîé Procesando: "${activity.name}"`);
                    console.log(`   Firebase Key: ${key}`);
                    console.log(`   Datos completos:`, activity);
                    return { firebaseKey: key, ...activity };
                })
                .filter(activity => {
                    console.log(`\n‚úì Evaluando filtros para: "${activity.name}"`);
                    console.log(`   1Ô∏è‚É£ sectionId: ${activity.sectionId} === ${sectionId}?`, activity.sectionId === sectionId);
                    console.log(`   2Ô∏è‚É£ status: "${activity.status}" === "approved"?`, activity.status === 'approved');
                    
                    if (activity.sectionId !== sectionId) {
                        console.log(`   ‚ùå DESCARTADA: Secci√≥n diferente`);
                        return false;
                    }
                    if (activity.status !== 'approved') {
                        console.log(`   ‚ùå DESCARTADA: Status no aprobado (actual: "${activity.status}")`);
                        return false;
                    }
                    
                    // Verificar si debe ejecutarse hoy o antes
                    const targetDate = activity.lastExecution ? activity.nextExecution : activity.firstExecution;
                    console.log(`   3Ô∏è‚É£ Fecha objetivo:`, targetDate);
                    console.log(`   3Ô∏è‚É£ lastExecution:`, activity.lastExecution || 'ninguna');
                    console.log(`   3Ô∏è‚É£ nextExecution:`, activity.nextExecution || 'ninguna');
                    console.log(`   3Ô∏è‚É£ firstExecution:`, activity.firstExecution);
                    console.log(`   3Ô∏è‚É£ Comparaci√≥n: "${targetDate}" <= "${currentDate}"?`, targetDate <= currentDate);
                    
                    const shouldShow = targetDate <= currentDate;
                    if (shouldShow) {
                        console.log(`   ‚úÖ INCLUIDA - Cumple todos los criterios`);
                    } else {
                        console.log(`   ‚ùå DESCARTADA: Fecha es futura (no debe aparecer a√∫n)`);
                    }
                    
                    return shouldShow;
                });
            
            console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`‚úÖ RESULTADO FINAL: ${periodicActivities.length} actividad(es) a mostrar`);
            if (periodicActivities.length > 0) {
                console.log('üìã Actividades que se mostrar√°n:');
                periodicActivities.forEach((act, idx) => {
                    console.log(`   ${idx + 1}. ${act.name} (${act.frequency})`);
                });
            }
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
            
            // Mostrar actividades peri√≥dicas primero si hay
            if (periodicActivities.length > 0) {
                const headerPeriodic = document.createElement('div');
                headerPeriodic.style.cssText = 'background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 12px 20px; margin: 0 0 15px 0; border-radius: 8px; font-weight: bold; font-size: 16px; text-align: center;';
                headerPeriodic.innerHTML = 'üìÖ ACTIVIDADES PERI√ìDICAS (Programadas)';
                content.appendChild(headerPeriodic);
                
                periodicActivities.forEach(activity => {
                    renderPeriodicActivityField(content, activity);
                });
            }
            
            if (sectionActivities.length === 0) {
                if (periodicActivities.length === 0) {
                    content.innerHTML = '<p style="padding: 20px; color: #666;">No hay actividades configuradas</p>';
                }
            } else {
                // Separar actividades por frecuencia
                const actividades2Veces = sectionActivities.filter(a => a.frequency === '2 veces al dia');
                const actividadesOtras = sectionActivities.filter(a => a.frequency !== '2 veces al dia');
                
                if (actividades2Veces.length > 0) {
                    // Header TURNO MA√ëANA
                    const headerManana = document.createElement('div');
                    headerManana.style.cssText = 'background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); color: white; padding: 12px 20px; margin: 20px 0 15px 0; border-radius: 8px; font-weight: bold; font-size: 16px; text-align: center;';
                    headerManana.innerHTML = 'üåÖ TURNO MA√ëANA';
                    content.appendChild(headerManana);
                    
                    // Todas las actividades de MA√ëANA
                    actividades2Veces.forEach(activity => {
                        renderActivityField(content, activity, 'manana');
                    });
                    
                    // Header TURNO TARDE
                    const headerTarde = document.createElement('div');
                    headerTarde.style.cssText = 'background: linear-gradient(135deg, #5C6BC0 0%, #3F51B5 100%); color: white; padding: 12px 20px; margin: 20px 0 15px 0; border-radius: 8px; font-weight: bold; font-size: 16px; text-align: center;';
                    headerTarde.innerHTML = 'üåÜ TURNO TARDE';
                    content.appendChild(headerTarde);
                    
                    // Todas las actividades de TARDE
                    actividades2Veces.forEach(activity => {
                        renderActivityField(content, activity, 'tarde');
                    });
                }
                
                // Actividades que no son "2 veces al dia"
                actividadesOtras.forEach(activity => {
                    renderActivityField(content, activity);
                });
            }

            // Fotos de la secci√≥n
            const photosDiv = document.createElement('div');
            photosDiv.className = 'form-group';
            photosDiv.innerHTML = `
                <label>üì∏ Fotos de esta Secci√≥n (Opcional):</label>
                <input type="file" id="sectionPhotos_${sectionId}" multiple accept="image/*" style="display: none;">
                <div class="photo-upload" onclick="document.getElementById('sectionPhotos_${sectionId}').click()">
                    <p>üì∑ Haz clic para agregar fotos</p>
                </div>
                <div id="sectionPhotosPreview_${sectionId}" class="photo-preview"></div>
            `;
            content.appendChild(photosDiv);

            document.getElementById(`sectionPhotos_${sectionId}`).addEventListener('change', function(e) {
                const preview = document.getElementById(`sectionPhotosPreview_${sectionId}`);
                preview.innerHTML = '';
                for (let file of e.target.files) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function renderPeriodicActivityField(container, activity) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'activity-field periodic';
            fieldDiv.style.cssText = 'background: #e3f2fd; border-left: 4px solid #2196f3; margin-bottom: 15px; padding: 15px; border-radius: 8px;';
            
            const frequencyLabel = getFrequencyLabel(activity.frequency);
            const daysOverdue = activity.nextExecution ? calculateDaysOverdue(activity.nextExecution) : 0;
            const isOverdue = daysOverdue > 0;
            
            fieldDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <strong style="font-size: 16px; color: #1976d2;">üîµ ${activity.name}</strong>
                        <div style="margin-top: 5px; font-size: 13px; color: #666;">
                            <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">
                                ${frequencyLabel}
                            </span>
                            ${activity.lastExecution 
                                ? `√öltima: ${formatDateShort(activity.lastExecution)} | Pr√≥xima: ${formatDateShort(activity.nextExecution)}`
                                : `Primera ejecuci√≥n programada: ${formatDateShort(activity.firstExecution)}`
                            }
                            ${isOverdue ? `<span style="color: #dc3545; font-weight: bold; margin-left: 8px;">‚ö†Ô∏è Vencida (${daysOverdue} d√≠as)</span>` : ''}
                        </div>
                        ${activity.description ? `<p style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">${activity.description}</p>` : ''}
                    </div>
                    <button onclick="executePeriodicActivity('${activity.firebaseKey}')" 
                            style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; white-space: nowrap;">
                        ‚úì Ejecutar
                    </button>
                </div>
            `;
            
            container.appendChild(fieldDiv);
        }
        
        async function executePeriodicActivity(firebaseKey) {
            const activity = planActivities[firebaseKey];
            if (!activity) {
                alert('Actividad no encontrada');
                return;
            }
            
            const confirmed = confirm(`¬øConfirmar ejecuci√≥n de:\n\n"${activity.name}"\n\nSe registrar√° como ejecutada el ${new Date(currentDate).toLocaleDateString('es-ES')}`);
            if (!confirmed) return;
            
            try {
                showSyncIndicator('‚öôÔ∏è Registrando ejecuci√≥n...', 'syncing');
                
                // Calcular pr√≥xima ejecuci√≥n
                const nextDate = new Date(currentDate);
                nextDate.setDate(nextDate.getDate() + activity.frequencyDays);
                const nextExecution = nextDate.toISOString().split('T')[0];
                
                // Actualizar en Firebase
                await planActivitiesRef.child(firebaseKey).update({
                    lastExecution: currentDate,
                    nextExecution: nextExecution,
                    status: 'approved' // Mantener aprobada
                });
                
                showSyncIndicator('‚úì Actividad ejecutada correctamente', 'synced');
                
                // Recargar vista
                if (currentSectionId) {
                    showSectionDetail(currentSectionId);
                }
            } catch (error) {
                console.error('Error al ejecutar actividad:', error);
                showSyncIndicator('‚úó Error al ejecutar', 'error');
            }
        }

        function renderActivityField(container, activity, turno = null) {
            if (!dailyLogs[currentDate] || !dailyLogs[currentDate].sections[currentSectionId]) {
                console.error('Data not initialized!');
                return;
            }

            const activityKey = turno ? `${activity.id}_${turno}` : activity.id;
            
            if (!dailyLogs[currentDate].sections[currentSectionId].activities[activityKey]) {
                dailyLogs[currentDate].sections[currentSectionId].activities[activityKey] = {
                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                };
            }

            const activityData = dailyLogs[currentDate].sections[currentSectionId].activities[activityKey];
            
            const fieldDiv = document.createElement('div');
            const turnoLabel = turno ? ` (${turno === 'manana' ? 'Ma√±ana' : 'Tarde'})` : '';
            
            if (activity.type === 'parametros') {
                const value = activityData.value;
                // Verificar que tenga valor v√°lido (no null, no undefined, no NaN, no string vac√≠o)
                const hasValue = value !== null && value !== undefined && value !== '' && !isNaN(value);
                const hasAlert = hasValue && activity.min && activity.max && (parseFloat(value) < activity.min || parseFloat(value) > activity.max);
                
                // Campo VERDE si tiene valor (incluso fuera de rango), NARANJA si est√° vac√≠o
                let fieldClass = hasValue ? 'completed' : 'pending';
                
                fieldDiv.className = `activity-field ${fieldClass}`;
                
                fieldDiv.innerHTML = `
                    <label>${activity.name}${turnoLabel} ${activity.unit ? `(${activity.unit})` : ''}:</label>
                    <input type="number" step="0.1" id="activity_${activityKey}" 
                           value="${hasValue ? value : ''}" 
                           class="${hasValue ? 'completed' : 'pending'}"
                           onchange="updateActivityValue(${activity.id}, '${turno || ''}', this.value)"
                           onkeypress="handleEnterKey(event, 'activity_${activityKey}')">
                    ${hasAlert ? `<div class="alert-message">‚ö†Ô∏è Fuera de rango (${activity.min} - ${activity.max} ${activity.unit})</div>` : ''}
                    ${activity.min && activity.max ? `<small style="color: #666;">Rango normal: ${activity.min} - ${activity.max} ${activity.unit}</small>` : ''}
                `;
            } else if (activity.type === 'nivel_aceite') {
                // Campo especial para Nivel de Aceite con 4 niveles
                const oilLevel = activityData.oilLevel || '';
                const isCompleted = oilLevel !== '';
                const hasAlert = oilLevel === '1/2' || oilLevel === 'vacio';
                
                fieldDiv.className = `activity-field ${isCompleted ? 'completed' : 'pending'}`;
                
                fieldDiv.innerHTML = `
                    <label>${activity.name}${turnoLabel}:</label>
                    <select id="activity_${activityKey}_oil" 
                            class="${isCompleted ? 'completed' : 'pending'}"
                            style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid ${isCompleted ? '#28a745' : '#ffc107'}; font-size: 14px;"
                            onchange="updateOilLevel(${activity.id}, '${turno || ''}', this.value)">
                        <option value="">-- Seleccionar nivel --</option>
                        <option value="full" ${oilLevel === 'full' ? 'selected' : ''}>üü¢ Full (Lleno)</option>
                        <option value="3/4" ${oilLevel === '3/4' ? 'selected' : ''}>üü° 3/4 (Tres cuartos)</option>
                        <option value="1/2" ${oilLevel === '1/2' ? 'selected' : ''}>üü† 1/2 (Medio)</option>
                        <option value="vacio" ${oilLevel === 'vacio' ? 'selected' : ''}>üî¥ Vac√≠o</option>
                    </select>
                    ${hasAlert ? `<div class="alert-message">‚ö†Ô∏è Nivel bajo - Umbral m√≠nimo</div>` : ''}
                    <div class="form-group" style="margin-top: 10px;">
                        <label>Observaciones:</label>
                        <input type="text" id="activity_${activityKey}_obs" 
                               value="${activityData.observations || ''}"
                               placeholder="Opcional"
                               onchange="updateActivityObservations(${activity.id}, '${turno || ''}', this.value)">
                    </div>
                `;
            } else {
                // Chequeo normal (‚úì OK)
                const status = activityData.status || '';
                const isCompleted = status === 'ok';
                
                fieldDiv.className = `activity-field ${isCompleted ? 'completed' : 'pending'}`;
                
                fieldDiv.innerHTML = `
                    <label>${activity.name}${turnoLabel}:</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="activity_${activityKey}_ok" 
                               ${status === 'ok' ? 'checked' : ''}
                               onchange="updateActivityStatus(${activity.id}, '${turno || ''}', 'ok', this.checked)">
                        <label for="activity_${activityKey}_ok">‚úì OK</label>
                    </div>
                    <div class="form-group">
                        <label>Observaciones:</label>
                        <input type="text" id="activity_${activityKey}_obs" 
                               value="${activityData.observations || ''}"
                               placeholder="Opcional"
                               onchange="updateActivityObservations(${activity.id}, '${turno || ''}', this.value)">
                    </div>
                `;
            }
            
            container.appendChild(fieldDiv);
        }
        
        async function updateOilLevel(activityId, turno, level) {
            const activityKey = turno ? `${activityId}_${turno}` : activityId;
            const path = `dailyLogs/${currentDate}/sections/${currentSectionId}/activities/${activityKey}`;
            
            await database.ref(path).update({
                oilLevel: level || null,
                user: level ? currentUser.fullName : null,
                timestamp: level ? new Date().toISOString() : null
            });
            
            showSyncIndicator('üíæ Guardando...', 'syncing');
            
            // Actualizar alerta inmediatamente en el DOM
            const selectElement = document.getElementById(`activity_${activityKey}_oil`);
            if (selectElement) {
                const fieldDiv = selectElement.closest('.activity-field');
                const hasAlert = level === '1/2' || level === 'vacio';
                
                // Actualizar clase del fieldDiv (para el color de fondo)
                if (level) {
                    fieldDiv.className = 'activity-field completed';
                } else {
                    fieldDiv.className = 'activity-field pending';
                }
                
                // Buscar si ya existe un div de alerta
                let alertDiv = fieldDiv.querySelector('.alert-message');
                
                if (hasAlert) {
                    // Si debe haber alerta y no existe, crearla
                    if (!alertDiv) {
                        alertDiv = document.createElement('div');
                        alertDiv.className = 'alert-message';
                        alertDiv.textContent = '‚ö†Ô∏è Nivel bajo - Umbral m√≠nimo';
                        selectElement.insertAdjacentElement('afterend', alertDiv);
                    }
                } else {
                    // Si no debe haber alerta y existe, eliminarla
                    if (alertDiv) {
                        alertDiv.remove();
                    }
                }
                
                // Actualizar borde del select
                if (level) {
                    selectElement.style.border = '2px solid #28a745';
                    selectElement.className = 'completed';
                } else {
                    selectElement.style.border = '2px solid #ffc107';
                    selectElement.className = 'pending';
                }
            }
            
            // Re-renderizar secciones para actualizar porcentaje
            setTimeout(() => {
                renderSections();
            }, 300);
        }

        async function updateActivityValue(activityId, turno, value) {
            const activityKey = turno ? `${activityId}_${turno}` : activityId;
            const path = `dailyLogs/${currentDate}/sections/${currentSectionId}/activities/${activityKey}`;
            
            // Si el campo est√° vac√≠o, guardar null expl√≠citamente
            const numValue = value === '' || value === null || value === undefined ? null : parseFloat(value);
            
            await database.ref(path).update({
                value: numValue,
                user: numValue !== null ? currentUser.fullName : null,
                timestamp: numValue !== null ? new Date().toISOString() : null
            });
            
            showSyncIndicator('üíæ Guardando...', 'syncing');
            
            // Re-renderizar tanto secciones como la vista detallada para actualizar colores
            setTimeout(() => {
                renderSections();
                if (currentSectionId) {
                    showSectionDetail(currentSectionId);
                }
            }, 300);
        }

        async function updateActivityStatus(activityId, turno, status, checked) {
            const activityKey = turno ? `${activityId}_${turno}` : activityId;
            const path = `dailyLogs/${currentDate}/sections/${currentSectionId}/activities/${activityKey}`;
            
            await database.ref(path).update({
                status: checked ? status : null,
                user: currentUser.fullName,
                timestamp: new Date().toISOString()
            });
            
            showSyncIndicator('üíæ Guardando...', 'syncing');
            
            // Re-renderizar tanto secciones como la vista detallada para actualizar colores
            setTimeout(() => {
                renderSections();
                if (currentSectionId) {
                    showSectionDetail(currentSectionId);
                }
            }, 300);
        }

        async function updateActivityObservations(activityId, turno, observations) {
            const activityKey = turno ? `${activityId}_${turno}` : activityId;
            const path = `dailyLogs/${currentDate}/sections/${currentSectionId}/activities/${activityKey}`;
            
            await database.ref(path).update({
                observations: observations
            });
            
            showSyncIndicator('üíæ Guardando...', 'syncing');
        }

        function handleEnterKey(event, currentFieldId) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                
                // Buscar todos los campos de input num√©ricos en el contenedor
                const allInputs = Array.from(document.querySelectorAll('#sectionDetailContent input[type="number"]'));
                
                // Encontrar el √≠ndice del campo actual
                const currentIndex = allInputs.findIndex(input => input.id === currentFieldId);
                
                // Si encontramos el campo actual y hay un siguiente
                if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {
                    const nextInput = allInputs[currentIndex + 1];
                    
                    // Dar tiempo para que se guarde el valor actual
                    setTimeout(() => {
                        nextInput.focus();
                        nextInput.select(); // Selecciona el contenido para facilitar sobrescritura
                    }, 100);
                }
            }
        }

        function backToSectionsList() {
            document.getElementById('sectionDetail').classList.remove('active');
            document.getElementById('sectionsList').style.display = 'block';
            renderSections();
        }

        function saveSectionAndReturn() {
            showSyncIndicator('‚úì Secci√≥n guardada', 'synced');
            backToSectionsList();
        }

        // ==================== NOVEDADES ====================
        
        function openReportNovedadModal() {
            const modal = document.getElementById('novedadesModal');
            const content = document.getElementById('novedadesModalContent');
            
            // Resetear fotos acumuladas al abrir modal
            accumulatedPhotos = [];
            
            content.innerHTML = `
                <div class="form-group">
                    <label>Secci√≥n/Equipo:</label>
                    <select id="novedadSection" onchange="toggleNovedadForm()" style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px;">
                        <option value="" selected>General (sin secci√≥n)</option>
                        ${sections.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('')}
                    </select>
                </div>
                
                <div id="novedadesPredefinidasContainer" class="form-group" style="display: block; background: #f0f8ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #0066cc; margin-bottom: 10px; font-size: 14px; text-align: center;">‚ïê‚ïê‚ïê NOVEDADES PREDEFINIDAS ‚ïê‚ïê‚ïê</h4>
                    <div id="novedadesPredefinidas">
                        ${novedadesPredefinidas.map(n => `
                            <div class="checkbox-group" style="margin: 8px 0; padding: 10px; background: #fff; border-radius: 5px;">
                                <input type="checkbox" id="novedad_${n.id}" value="${n.text}" style="margin-right: 10px; width: 18px; height: 18px;">
                                <label for="novedad_${n.id}" style="cursor: pointer;">${n.text}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="form-group" id="novedadTextContainer">
                    <label id="novedadTextLabel">Novedad adicional (opcional):</label>
                    <textarea id="customNovedad" rows="3" placeholder="Escribe aqu√≠ cualquier novedad adicional..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>üì∑ Fotos (Opcional - M√°ximo 3):</label>
                    <input type="file" id="novedadPhotos" accept="image/*" capture="environment" style="display: none;">
                    <div class="photo-upload" onclick="document.getElementById('novedadPhotos').click()">
                        <p>üì∑ Agregar foto (<span id="photoCount">0</span>/3)</p>
                        <small style="color: #999;">Toca para tomar o seleccionar foto</small>
                    </div>
                    <div id="novedadPhotosPreview" class="photo-preview"></div>
                </div>
                <button onclick="saveNovedad()" class="btn">üíæ Guardar Novedad</button>
            `;
            
            // Event listener para agregar fotos de forma acumulativa
            document.getElementById('novedadPhotos').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                
                // Agregar nuevas fotos sin exceder 3 en total
                files.forEach(file => {
                    if (accumulatedPhotos.length < 3) {
                        accumulatedPhotos.push(file);
                    }
                });
                
                // Actualizar preview
                updatePhotosPreview();
                
                // Resetear input para permitir seleccionar la misma foto de nuevo
                e.target.value = '';
            });
            
            modal.style.display = 'block';
        }
        
        function toggleNovedadForm() {
            const sectionSelect = document.getElementById('novedadSection');
            const selectedSection = sectionSelect ? sectionSelect.value : '';
            
            const predefinidasContainer = document.getElementById('novedadesPredefinidasContainer');
            const textLabel = document.getElementById('novedadTextLabel');
            const textArea = document.getElementById('customNovedad');
            
            if (!predefinidasContainer || !textLabel || !textArea) return;
            
            if (selectedSection === '') {
                // MODO GENERAL: Mostrar checkboxes predefinidas
                predefinidasContainer.style.display = 'block';
                textLabel.textContent = 'Novedad adicional (opcional):';
                textArea.placeholder = 'Escribe aqu√≠ cualquier novedad adicional...';
                textArea.required = false;
            } else {
                // MODO SECCI√ìN ESPEC√çFICA: Solo texto libre
                predefinidasContainer.style.display = 'none';
                textLabel.textContent = 'Novedad:';
                textArea.placeholder = 'Describe la novedad o incidencia del equipo...';
                textArea.required = true;
            }
        }
        
        function updatePhotosPreview() {
            const preview = document.getElementById('novedadPhotosPreview');
            const counter = document.getElementById('photoCount');
            
            preview.innerHTML = '';
            counter.textContent = accumulatedPhotos.length;
            
            accumulatedPhotos.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const photoDiv = document.createElement('div');
                    photoDiv.style.cssText = 'position: relative; display: inline-block; margin: 5px;';
                    
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 8px;';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '‚úï';
                    removeBtn.style.cssText = 'position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px;';
                    removeBtn.onclick = () => removePhoto(index);
                    
                    photoDiv.appendChild(img);
                    photoDiv.appendChild(removeBtn);
                    preview.appendChild(photoDiv);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function removePhoto(index) {
            accumulatedPhotos.splice(index, 1);
            updatePhotosPreview();
        }

        function closeNovedadesModal() {
            document.getElementById('novedadesModal').style.display = 'none';
        }

        async function saveNovedad() {
            const sectionId = document.getElementById('novedadSection').value;
            const customNovedad = document.getElementById('customNovedad').value.trim();
            
            let novedadText = '';
            
            if (sectionId === '') {
                // GENERAL: Recoger checkboxes seleccionados
                const selectedNovedades = [];
                
                novedadesPredefinidas.forEach(n => {
                    const checkbox = document.getElementById(`novedad_${n.id}`);
                    if (checkbox && checkbox.checked) {
                        selectedNovedades.push(n.text);
                    }
                });
                
                // Combinar predefinidas con texto adicional
                if (selectedNovedades.length > 0) {
                    novedadText = selectedNovedades.join(', ');
                }
                
                if (customNovedad) {
                    novedadText += (novedadText ? '. ' : '') + customNovedad;
                }
                
                if (!novedadText) {
                    alert('‚ö†Ô∏è Debes seleccionar al menos una novedad predefinida o escribir una novedad adicional');
                    return;
                }
                
            } else {
                // SECCI√ìN ESPEC√çFICA: Solo texto libre
                novedadText = customNovedad;
                
                if (!novedadText) {
                    alert('‚ö†Ô∏è Debes escribir la novedad del equipo');
                    return;
                }
            }
            
            // Determinar nombre de secci√≥n
            const sectionName = sectionId 
                ? sections.find(s => s.id == sectionId)?.name || 'General'
                : 'General';
            
            showSyncIndicator('üíæ Guardando novedad...', 'syncing');
            
            // Subir fotos acumuladas si hay
            const photoURLs = [];
            
            if (accumulatedPhotos.length > 0) {
                showSyncIndicator('üì∑ Subiendo fotos...', 'syncing');
                
                for (let i = 0; i < accumulatedPhotos.length; i++) {
                    const file = accumulatedPhotos[i];
                    const timestamp = Date.now();
                    const fileName = `novedades/${currentDate}/${timestamp}_${i}.jpg`;
                    const storageRef = storage.ref(fileName);
                    
                    try {
                        await storageRef.put(file);
                        const url = await storageRef.getDownloadURL();
                        photoURLs.push(url);
                    } catch (error) {
                        console.error('Error subiendo foto:', error);
                    }
                }
            }
            
            // Crear objeto novedad
            const novedad = {
                id: Date.now(),
                sectionId: sectionId || null,
                sectionName: sectionName,
                text: novedadText,
                user: currentUser.fullName,
                timestamp: new Date().toISOString(),
                photos: photoURLs
            };
            
            try {
                // Guardar en Firebase (nueva estructura)
                await novedadesRef.child(currentDate).push(novedad);
                
                // Tambi√©n guardar en dailyLogs para compatibilidad con reporte diario
                const currentNovedades = dailyLogs[currentDate].novedades || [];
                currentNovedades.push(novedad);
                await database.ref(`dailyLogs/${currentDate}/novedades`).set(currentNovedades);
                
                showSyncIndicator('‚úì Novedad guardada', 'synced');
                closeNovedadesModal();
                renderSections();
                
                // Limpiar fotos acumuladas
                accumulatedPhotos = [];
                
            } catch (error) {
                console.error('Error al guardar novedad:', error);
                showSyncIndicator('‚úó Error al guardar', 'error');
            }
        }

        // ==================== REPORTE DIARIO ====================
        
        function renderReporteDiario() {
            const container = document.getElementById('reportContent');
            
            if (!dailyLogs[currentDate]) {
                container.innerHTML = '<div class="report-summary"><p>No hay datos para el d√≠a actual. Completa algunas actividades primero.</p></div>';
                return;
            }
            
            let fullHTML = '';
            
            // SECCI√ìN 1: D√çA ACTUAL (En proceso)
            fullHTML += renderDayReport(currentDate, true);
            
            // SECCI√ìN 2: D√çA ANTERIOR (Cerrado)
            const yesterday = new Date(currentDate);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (dailyLogs[yesterdayStr]) {
                fullHTML += renderDayReport(yesterdayStr, false);
            }
            
            container.innerHTML = fullHTML;
        }
        
        function renderDayReport(dateStr, isCurrentDay) {
            if (!dailyLogs[dateStr]) {
                return '';
            }
            
            const statusLabel = isCurrentDay ? 'üü¢ En proceso' : 'üî¥ Cerrado';
            const statusColor = isCurrentDay ? '#28a745' : '#dc3545';
            
            let totalActivities = 0;
            let completedActivities = 0;
            let reportHTML = '';

            // Calcular estad√≠sticas
            sections.forEach(section => {
                // Verificar que la secci√≥n existe en el dailyLog
                if (!dailyLogs[dateStr].sections[section.id]) {
                    console.warn(`Secci√≥n ${section.name} (id:${section.id}) no existe en el log de ${dateStr}`);
                    return; // Skip esta secci√≥n
                }
                
                const sectionActivities = activities.filter(a => a.sectionId === section.id);
                
                sectionActivities.forEach(activity => {
                    if (activity.frequency === '2 veces al dia') {
                        totalActivities += 2;
                        const dataMorning = dailyLogs[dateStr].sections[section.id].activities[`${activity.id}_manana`];
                        const dataAfternoon = dailyLogs[dateStr].sections[section.id].activities[`${activity.id}_tarde`];
                        
                        if (activity.type === 'parametros') {
                            // Cuenta como completado si tiene CUALQUIER valor v√°lido (incluso fuera de rango)
                            if (dataMorning && dataMorning.value !== null && dataMorning.value !== undefined && dataMorning.value !== '' && !isNaN(dataMorning.value)) {
                                completedActivities++;
                            }
                            if (dataAfternoon && dataAfternoon.value !== null && dataAfternoon.value !== undefined && dataAfternoon.value !== '' && !isNaN(dataAfternoon.value)) {
                                completedActivities++;
                            }
                        } else {
                            // Para chequeos, cuenta si est√° marcado OK o tiene nivel de aceite
                            if (dataMorning && (dataMorning.status === 'ok' || dataMorning.oilLevel)) completedActivities++;
                            if (dataAfternoon && (dataAfternoon.status === 'ok' || dataAfternoon.oilLevel)) completedActivities++;
                        }
                    }
                });
            });

            const percentage = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
            const pendingActivities = totalActivities - completedActivities;

            // Encabezado con fecha y estado
            reportHTML = `
                <div class="report-summary" style="border-left: 4px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1e3c72; margin: 0;">
                            ${new Date(dateStr + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}
                        </h3>
                        <span style="background: ${statusColor}; color: white; padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: bold;">
                            ${statusLabel}
                        </span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${totalActivities}</div>
                            <div class="stat-label">Total Actividades</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${completedActivities}</div>
                            <div class="stat-label">Completadas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${pendingActivities}</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${percentage}%</div>
                            <div class="stat-label">Porcentaje</div>
                        </div>
                    </div>
                </div>
            `;

            // Mostrar detalles por secci√≥n seg√∫n configuraci√≥n showInSummary
            sections.forEach(section => {
                // Verificar que la secci√≥n existe en el dailyLog
                if (!dailyLogs[dateStr].sections[section.id]) {
                    return; // Skip esta secci√≥n
                }
                
                // Usar showInSummary de la secci√≥n (por defecto "resumido" si no existe)
                const showInSummary = section.showInSummary || 'resumido';
                
                // Si la secci√≥n est√° configurada como "no", no mostrarla
                if (showInSummary === 'no') {
                    return;
                }
                
                // Calcular estad√≠sticas de la secci√≥n
                const sectionActivities = activities.filter(a => a.sectionId === section.id);
                let sectionTotal = 0;
                let sectionCompleted = 0;
                
                sectionActivities.forEach(activity => {
                    if (activity.frequency === '2 veces al dia') {
                        sectionTotal += 2;
                        const dataMorning = dailyLogs[dateStr].sections[section.id].activities[activity.id + '_manana'];
                        const dataAfternoon = dailyLogs[dateStr].sections[section.id].activities[activity.id + '_tarde'];
                        
                        if (activity.type === 'parametros') {
                            if (dataMorning && dataMorning.value !== null && !isNaN(dataMorning.value)) sectionCompleted++;
                            if (dataAfternoon && dataAfternoon.value !== null && !isNaN(dataAfternoon.value)) sectionCompleted++;
                        } else if (activity.type === 'nivel_aceite') {
                            if (dataMorning && dataMorning.oilLevel) sectionCompleted++;
                            if (dataAfternoon && dataAfternoon.oilLevel) sectionCompleted++;
                        } else {
                            if (dataMorning && dataMorning.status === 'ok') sectionCompleted++;
                            if (dataAfternoon && dataAfternoon.status === 'ok') sectionCompleted++;
                        }
                    } else if (activity.frequency === 'Diario') {
                        sectionTotal += 1;
                        const activityData = dailyLogs[dateStr].sections[section.id].activities[activity.id];
                        
                        if (activity.type === 'parametros') {
                            if (activityData && activityData.value !== null && !isNaN(activityData.value)) sectionCompleted++;
                        } else if (activity.type === 'nivel_aceite') {
                            if (activityData && activityData.oilLevel) sectionCompleted++;
                        } else {
                            if (activityData && activityData.status === 'ok') sectionCompleted++;
                        }
                    }
                });
                
                // Si no hay actividades en la secci√≥n, no mostrarla
                if (sectionTotal === 0) return;
                
                const sectionPercentage = Math.round((sectionCompleted / sectionTotal) * 100);
                
                // MODO RESUMIDO: Solo mostrar porcentaje
                if (showInSummary === 'resumido') {
                    reportHTML += '<div class="report-summary">';
                    reportHTML += '<h3>' + section.icon + ' ' + section.name + '</h3>';
                    reportHTML += '<p style="font-size: 16px; color: ' + (sectionPercentage === 100 ? '#28a745' : '#667eea') + '; font-weight: bold;">';
                    reportHTML += sectionCompleted + '/' + sectionTotal + ' (' + sectionPercentage + '%)';
                    reportHTML += '</p></div>';
                    return;
                }
                
                // MODO DETALLE: Mostrar porcentaje + actividades
                let sectionHTML = '';
                
                sectionActivities.forEach(activity => {
                    if (activity.frequency === '2 veces al dia') {
                        const dataMorning = dailyLogs[dateStr].sections[section.id].activities[activity.id + '_manana'];
                        const dataAfternoon = dailyLogs[dateStr].sections[section.id].activities[activity.id + '_tarde'];
                        
                        if (activity.type === 'parametros') {
                            if (dataMorning && dataMorning.value !== null && !isNaN(dataMorning.value)) {
                                const userInfo = dataMorning.user || 'Usuario';
                                const timeInfo = dataMorning.timestamp ? new Date(dataMorning.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                const value = parseFloat(dataMorning.value);
                                const isOutOfRange = (activity.min !== null && activity.min !== undefined && value < activity.min) || 
                                                    (activity.max !== null && activity.max !== undefined && value > activity.max);
                                const alertSymbol = isOutOfRange ? '‚ö†Ô∏è ' : '';
                                const textColor = isOutOfRange ? 'color: #dc3545; font-weight: bold;' : '';
                                
                                sectionHTML += '<p style="' + textColor + '"><strong>' + activity.name + ' (Ma√±ana):</strong> ';
                                sectionHTML += alertSymbol + dataMorning.value + ' ' + (activity.unit || '');
                                if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                                sectionHTML += '</p>';
                            }
                            
                            if (dataAfternoon && dataAfternoon.value !== null && !isNaN(dataAfternoon.value)) {
                                const userInfo = dataAfternoon.user || 'Usuario';
                                const timeInfo = dataAfternoon.timestamp ? new Date(dataAfternoon.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                const value = parseFloat(dataAfternoon.value);
                                const isOutOfRange = (activity.min !== null && activity.min !== undefined && value < activity.min) || 
                                                    (activity.max !== null && activity.max !== undefined && value > activity.max);
                                const alertSymbol = isOutOfRange ? '‚ö†Ô∏è ' : '';
                                const textColor = isOutOfRange ? 'color: #dc3545; font-weight: bold;' : '';
                                
                                sectionHTML += '<p style="' + textColor + '"><strong>' + activity.name + ' (Tarde):</strong> ';
                                sectionHTML += alertSymbol + dataAfternoon.value + ' ' + (activity.unit || '');
                                if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                                sectionHTML += '</p>';
                            }
                        } else if (activity.type === 'nivel_aceite') {
                            if (dataMorning && dataMorning.oilLevel) {
                                const userInfo = dataMorning.user || 'Usuario';
                                const timeInfo = dataMorning.timestamp ? new Date(dataMorning.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                const oilLevelText = {'full': 'üü¢ Full', '3/4': 'üü° 3/4', '1/2': 'üü† 1/2', 'vacio': 'üî¥ Vac√≠o'}[dataMorning.oilLevel] || dataMorning.oilLevel;
                                
                                sectionHTML += '<p><strong>' + activity.name + ' (Ma√±ana):</strong> ' + oilLevelText;
                                if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                                sectionHTML += '</p>';
                            }
                            
                            if (dataAfternoon && dataAfternoon.oilLevel) {
                                const userInfo = dataAfternoon.user || 'Usuario';
                                const timeInfo = dataAfternoon.timestamp ? new Date(dataAfternoon.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                const oilLevelText = {'full': 'üü¢ Full', '3/4': 'üü° 3/4', '1/2': 'üü† 1/2', 'vacio': 'üî¥ Vac√≠o'}[dataAfternoon.oilLevel] || dataAfternoon.oilLevel;
                                
                                sectionHTML += '<p><strong>' + activity.name + ' (Tarde):</strong> ' + oilLevelText;
                                if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                                sectionHTML += '</p>';
                            }
                        } else {
                            if (dataMorning && dataMorning.status === 'ok') {
                                const userInfo = dataMorning.user || 'Usuario';
                                const timeInfo = dataMorning.timestamp ? new Date(dataMorning.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                
                                sectionHTML += '<p><strong>' + activity.name + ' (Ma√±ana):</strong> ‚úì OK';
                                if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                                sectionHTML += '</p>';
                            }
                            
                            if (dataAfternoon && dataAfternoon.status === 'ok') {
                                const userInfo = dataAfternoon.user || 'Usuario';
                                const timeInfo = dataAfternoon.timestamp ? new Date(dataAfternoon.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                
                                sectionHTML += '<p><strong>' + activity.name + ' (Tarde):</strong> ‚úì OK';
                                if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                                sectionHTML += '</p>';
                            }
                        }
                    } else if (activity.frequency === 'Diario') {
                        const activityData = dailyLogs[dateStr].sections[section.id].activities[activity.id];
                        
                        if (activity.type === 'parametros' && activityData && activityData.value !== null && !isNaN(activityData.value)) {
                            const userInfo = activityData.user || 'Usuario';
                            const timeInfo = activityData.timestamp ? new Date(activityData.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                            const value = parseFloat(activityData.value);
                            const isOutOfRange = (activity.min !== null && activity.min !== undefined && value < activity.min) || 
                                                (activity.max !== null && activity.max !== undefined && value > activity.max);
                            const alertSymbol = isOutOfRange ? '‚ö†Ô∏è ' : '';
                            const textColor = isOutOfRange ? 'color: #dc3545; font-weight: bold;' : '';
                            
                            sectionHTML += '<p style="' + textColor + '"><strong>' + activity.name + ':</strong> ';
                            sectionHTML += alertSymbol + activityData.value + ' ' + (activity.unit || '');
                            if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                            sectionHTML += '</p>';
                        } else if (activity.type === 'nivel_aceite' && activityData && activityData.oilLevel) {
                            const userInfo = activityData.user || 'Usuario';
                            const timeInfo = activityData.timestamp ? new Date(activityData.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                            const oilLevelText = {'full': 'üü¢ Full', '3/4': 'üü° 3/4', '1/2': 'üü† 1/2', 'vacio': 'üî¥ Vac√≠o'}[activityData.oilLevel] || activityData.oilLevel;
                            
                            sectionHTML += '<p><strong>' + activity.name + ':</strong> ' + oilLevelText;
                            if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                            sectionHTML += '</p>';
                        } else if (activity.type === 'chequeo' && activityData && activityData.status === 'ok') {
                            const userInfo = activityData.user || 'Usuario';
                            const timeInfo = activityData.timestamp ? new Date(activityData.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                            
                            sectionHTML += '<p><strong>' + activity.name + ':</strong> ‚úì OK';
                            if (timeInfo) sectionHTML += ' <small style="color: #999;">(' + userInfo + ' - ' + timeInfo + ')</small>';
                            sectionHTML += '</p>';
                        }
                    }
                });
                
                // Solo agregar la secci√≥n si tiene contenido
                if (sectionHTML) {
                    reportHTML += '<div class="report-summary">';
                    reportHTML += '<h3>' + section.icon + ' ' + section.name + '</h3>';
                    reportHTML += '<p style="font-size: 16px; color: ' + (sectionPercentage === 100 ? '#28a745' : '#667eea') + '; font-weight: bold; margin-bottom: 10px;">';
                    reportHTML += sectionCompleted + '/' + sectionTotal + ' (' + sectionPercentage + '%)';
                    reportHTML += '</p>';
                    reportHTML += sectionHTML;
                    reportHTML += '</div>';
                }
            });


            // Mostrar novedades
            if (dailyLogs[dateStr].novedades && dailyLogs[dateStr].novedades.length > 0) {
                reportHTML += `<div class="report-summary"><h3>üìù Novedades del D√≠a</h3>`;
                
                dailyLogs[dateStr].novedades.forEach((novedad, index) => {
                    // Preparar datos
                    const sectionBadge = novedad.sectionName && novedad.sectionName !== 'General' 
                        ? `<span style="background: #667eea; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; margin-right: 8px;">üì¶ ${novedad.sectionName}</span>` 
                        : `<span style="background: #6c757d; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; margin-right: 8px;">üìã General</span>`;
                    
                    // Resumir texto (primeros 100 caracteres)
                    const fullText = novedad.text || '';
                    const shortText = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                    
                    // Foto en miniatura
                    const photoThumb = novedad.photos && novedad.photos.length > 0 
                        ? `<img src="${novedad.photos[0]}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-left: 10px; cursor: pointer; border: 2px solid #667eea;" onclick="openNovedadDetailModal('${dateStr}', ${index})">` 
                        : '';
                    
                    // Fecha y hora
                    const timestamp = novedad.timestamp ? new Date(novedad.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                    
                    reportHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea; cursor: pointer; transition: all 0.2s;" 
                             onclick="openNovedadDetailModal('${dateStr}', ${index})"
                             onmouseover="this.style.background='#e9ecef'" 
                             onmouseout="this.style.background='#f8f9fa'">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 5px;">
                                    ${sectionBadge}
                                    <small style="color: #6c757d;">üïê ${timestamp}</small>
                                </div>
                                <div style="color: #495057; font-size: 14px;">${shortText}</div>
                                <small style="color: #6c757d; font-size: 12px;">üë§ ${novedad.user}</small>
                            </div>
                            ${photoThumb}
                        </div>
                    `;
                });
                
                reportHTML += `</div>`;
            }

            return reportHTML;
        }
        
        function openPhotoCarouselForDate(dateStr, novedadIndex) {
            const novedad = dailyLogs[dateStr].novedades[novedadIndex];
            if (!novedad || !novedad.photos || novedad.photos.length === 0) return;
            
            const modal = document.createElement('div');
            modal.id = 'photoCarouselModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; flex-direction: column;
            `;
            
            let currentPhotoIndex = 0;
            
            const updatePhoto = () => {
                const img = document.getElementById('carouselImg');
                img.src = novedad.photos[currentPhotoIndex];
                const counter = document.getElementById('photoCounter');
                counter.textContent = `${currentPhotoIndex + 1} / ${novedad.photos.length}`;
            };
            
            modal.innerHTML = `
                <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 24px; cursor: pointer; z-index: 10001;" onclick="document.getElementById('photoCarouselModal').remove()">‚úï</div>
                <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 18px;" id="photoCounter"></div>
                <img id="carouselImg" src="${novedad.photos[0]}" style="max-width: 90%; max-height: 90%; border-radius: 8px;">
                ${novedad.photos.length > 1 ? `
                    <div style="position: absolute; bottom: 40px; display: flex; gap: 20px;">
                        <button id="prevBtn" style="background: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 18px;">‚Üê Anterior</button>
                        <button id="nextBtn" style="background: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 18px;">Siguiente ‚Üí</button>
                    </div>
                ` : ''}
            `;
            
            document.body.appendChild(modal);
            updatePhoto();
            
            if (novedad.photos.length > 1) {
                document.getElementById('prevBtn').onclick = () => {
                    currentPhotoIndex = (currentPhotoIndex - 1 + novedad.photos.length) % novedad.photos.length;
                    updatePhoto();
                };
                
                document.getElementById('nextBtn').onclick = () => {
                    currentPhotoIndex = (currentPhotoIndex + 1) % novedad.photos.length;
                    updatePhoto();
                };
            }
        }

        function openPhotoCarousel(novedadIndex) {
            openPhotoCarouselForDate(currentDate, novedadIndex);
        }
        
        function openNovedadDetailModal(dateStr, novedadIndex) {
            const novedad = dailyLogs[dateStr].novedades[novedadIndex];
            if (!novedad) return;
            
            // Crear modal
            const modal = document.createElement('div');
            modal.id = 'novedadDetailModal';
            modal.style.cssText = `
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(0,0,0,0.7); 
                z-index: 10000; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                padding: 20px;
            `;
            
            // Formatear fecha y hora completa
            const fullDateTime = novedad.timestamp 
                ? new Date(novedad.timestamp).toLocaleString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })
                : 'Fecha no disponible';
            
            // Secci√≥n
            const sectionInfo = novedad.sectionName && novedad.sectionName !== 'General'
                ? `<div style="margin-bottom: 15px;">
                     <strong style="color: #667eea;">üì¶ Secci√≥n:</strong> 
                     <span style="background: #667eea; color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px;">${novedad.sectionName}</span>
                   </div>`
                : `<div style="margin-bottom: 15px;">
                     <strong style="color: #6c757d;">üìã Categor√≠a:</strong> 
                     <span style="background: #6c757d; color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px;">General</span>
                   </div>`;
            
            // Fotos
            let photosHTML = '';
            if (novedad.photos && novedad.photos.length > 0) {
                photosHTML = `
                    <div style="margin-top: 20px;">
                        <strong style="color: #495057;">üì∑ Evidencias fotogr√°ficas (${novedad.photos.length}):</strong>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            ${novedad.photos.map((photo, idx) => `
                                <img src="${photo}" 
                                     style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 3px solid #667eea;" 
                                     onclick="openPhotoCarouselForDate('${dateStr}', ${novedadIndex}); document.getElementById('novedadDetailModal').remove();">
                            `).join('')}
                        </div>
                        <small style="color: #6c757d; display: block; margin-top: 5px;">Click en las fotos para ver en tama√±o completo</small>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px 12px 0 0; position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px; color: white; font-size: 28px; cursor: pointer; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); border-radius: 50%; transition: all 0.2s;" 
                             onclick="document.getElementById('novedadDetailModal').remove()"
                             onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                             onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            ‚úï
                        </div>
                        <h2 style="color: white; margin: 0; font-size: 24px;">üìù Detalle de Novedad</h2>
                        <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 14px;">Solo lectura</p>
                    </div>
                    
                    <!-- Contenido -->
                    <div style="padding: 25px;">
                        <!-- Secci√≥n -->
                        ${sectionInfo}
                        
                        <!-- Fecha y hora -->
                        <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                            <strong style="color: #495057;">üïê Fecha y Hora:</strong><br>
                            <span style="color: #6c757d; font-size: 14px;">${fullDateTime}</span>
                        </div>
                        
                        <!-- Usuario -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057;">üë§ Reportado por:</strong> 
                            <span style="color: #667eea; font-weight: 600;">${novedad.user}</span>
                        </div>
                        
                        <!-- Detalle completo -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057;">üìÑ Descripci√≥n completa:</strong>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 8px; border-left: 4px solid #28a745; line-height: 1.6;">
                                ${novedad.text}
                            </div>
                        </div>
                        
                        <!-- Fotos -->
                        ${photosHTML}
                    </div>
                    
                    <!-- Footer -->
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 0 0 12px 12px; text-align: center;">
                        <button onclick="document.getElementById('novedadDetailModal').remove()" 
                                style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;"
                                onmouseover="this.style.background='#5568d3'"
                                onmouseout="this.style.background='#667eea'">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar con click fuera del modal
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function openHistorialPhotoCarousel(date, novedadIndex) {
            const log = dailyLogs[date];
            if (!log || !log.novedades) return;
            
            const novedad = log.novedades[novedadIndex];
            if (!novedad || !novedad.photos || novedad.photos.length === 0) return;
            
            const modal = document.createElement('div');
            modal.id = 'photoCarouselModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; flex-direction: column;
            `;
            
            let currentPhotoIndex = 0;
            
            const updatePhoto = () => {
                const img = document.getElementById('carouselImg');
                img.src = novedad.photos[currentPhotoIndex];
                const counter = document.getElementById('photoCounter');
                counter.textContent = `${currentPhotoIndex + 1} / ${novedad.photos.length}`;
            };
            
            modal.innerHTML = `
                <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 24px; cursor: pointer; z-index: 10001;" onclick="document.getElementById('photoCarouselModal').remove()">‚úï</div>
                <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 18px;" id="photoCounter"></div>
                <img id="carouselImg" src="${novedad.photos[0]}" style="max-width: 90%; max-height: 90%; border-radius: 8px;">
                ${novedad.photos.length > 1 ? `
                    <div style="position: absolute; bottom: 40px; display: flex; gap: 20px;">
                        <button id="prevBtn" style="background: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 18px;">‚Üê Anterior</button>
                        <button id="nextBtn" style="background: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 18px;">Siguiente ‚Üí</button>
                    </div>
                ` : ''}
            `;
            
            document.body.appendChild(modal);
            updatePhoto();
            
            if (novedad.photos.length > 1) {
                document.getElementById('prevBtn').addEventListener('click', () => {
                    currentPhotoIndex = (currentPhotoIndex - 1 + novedad.photos.length) % novedad.photos.length;
                    updatePhoto();
                });
                
                document.getElementById('nextBtn').addEventListener('click', () => {
                    currentPhotoIndex = (currentPhotoIndex + 1) % novedad.photos.length;
                    updatePhoto();
                });
            }
        }

        function shareReport() {
            const message = `Reporte HSB - ${new Date(currentDate).toLocaleDateString('es-ES')}`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // ==================== PLAN ====================
        

        // ==================== HISTORIAL ====================
        
        let historialMode = 'porFecha'; // o 'porSeccion'
        
        function showHistorialMode(mode) {
            historialMode = mode;
            
            // Actualizar estilos de botones
            document.getElementById('btnHistorialPorFecha').style.background = mode === 'porFecha' ? '#667eea' : '#6c757d';
            document.getElementById('btnHistorialPorSeccion').style.background = mode === 'porSeccion' ? '#667eea' : '#6c757d';
            
            // Renderizar seg√∫n modo
            if (mode === 'porFecha') {
                renderHistorialPorFecha();
            } else {
                renderHistorialPorSeccion();
            }
        }
        
        function renderHistorial() {
            // Por defecto mostrar por fecha
            showHistorialMode('porFecha');
        }
        
        function renderHistorialPorFecha() {
            const container = document.getElementById('historialContent');
            
            const dates = Object.keys(dailyLogs).sort().reverse();
            
            if (dates.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No hay historial disponible</p>';
                return;
            }
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="color: #1e3c72; margin-bottom: 10px;">üìÖ Filtrar por fecha</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="historialFechaInicio" 
                               style="padding: 10px; border: 2px solid #667eea; border-radius: 5px; flex: 1;">
                        <span>hasta</span>
                        <input type="date" id="historialFechaFin" 
                               style="padding: 10px; border: 2px solid #667eea; border-radius: 5px; flex: 1;">
                        <button onclick="filtrarHistorialPorFecha()" 
                                style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            üîç Buscar
                        </button>
                    </div>
                </div>
            `;
            
            dates.forEach(date => {
                const log = dailyLogs[date];
                let completed = 0;
                let total = 0;

                sections.forEach(section => {
                    if (log.sections && log.sections[section.id]) {
                        Object.values(log.sections[section.id].activities || {}).forEach(activity => {
                            total++;
                            if (activity.value !== null || activity.status !== null) {
                                completed++;
                            }
                        });
                    }
                });

                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

                html += `
                    <div class="report-summary" style="margin-bottom: 15px; cursor: pointer; transition: all 0.3s;" 
                         onclick="toggleHistorialDetail('${date}')"
                         onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                         onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: #1e3c72;">üìÖ ${new Date(date).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</h3>
                                <p style="margin-top: 5px; color: #666;">Completado: ${percentage}% (${completed}/${total})</p>
                            </div>
                            <div style="font-size: 24px; color: #667eea;">
                                <span id="arrow_${date}">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="detail_${date}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                            <p style="color: #666; margin-bottom: 10px;"><em>Cargando detalles...</em></p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        // Hacer funci√≥n global
        window.renderHistorialPorSeccion = function() {
            console.log('üìä Renderizando historial por secci√≥n');
            const container = document.getElementById('historialContent');
            const sections = window.HSB_DATA.sections;
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
            
            sections.forEach(section => {
                html += `
                    <div style="flex: 1; min-width: 250px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s;"
                         onclick="window.showSeccionHistorial(${section.id})"
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                        <div style="font-size: 48px; text-align: center; margin-bottom: 10px;">${section.icon}</div>
                        <h3 style="text-align: center; color: #1e3c72; margin-bottom: 5px;">${section.name}</h3>
                        <p style="text-align: center; color: #666; font-size: 13px;">Click para ver historial</p>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            console.log('‚úÖ Grid de secciones renderizado');
        }
        
        // Hacer funci√≥n global
        window.showSeccionHistorial = function(sectionId) {
            console.log('üìä Mostrando historial de secci√≥n:', sectionId);
            const sections = window.HSB_DATA.sections;
            const dailyLogs = window.HSB_DATA.dailyLogs;
            const activities = window.HSB_DATA.activities;
            const novedades = window.HSB_DATA.novedades;
            
            const section = sections.find(s => s.id === sectionId);
            if (!section) {
                console.error('Secci√≥n no encontrada:', sectionId);
                return;
            }
            
            const container = document.getElementById('historialContent');
            
            // Bot√≥n volver
            let html = `
                <div style="margin-bottom: 20px;">
                    <button onclick="window.renderHistorialPorSeccion()" 
                            style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        ‚Üê Volver a Secciones
                    </button>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="color: #1e3c72; margin-bottom: 10px;">${section.icon} ${section.name}</h2>
                    <h3 style="color: #667eea; margin-bottom: 10px;">üìÖ Filtrar por fecha</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="seccionFechaInicio" 
                               style="padding: 10px; border: 2px solid #667eea; border-radius: 5px; flex: 1;">
                        <span>hasta</span>
                        <input type="date" id="seccionFechaFin" 
                               style="padding: 10px; border: 2px solid #667eea; border-radius: 5px; flex: 1;">
                        <button onclick="filtrarSeccionPorFecha(${sectionId})" 
                                style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            üîç Buscar
                        </button>
                    </div>
                </div>
            `;
            
            // Obtener todas las fechas con datos de esta secci√≥n
            const dates = Object.keys(dailyLogs).sort().reverse();
            const datesWithData = dates.filter(date => {
                const log = dailyLogs[date];
                return log.sections && log.sections[sectionId] && 
                       Object.keys(log.sections[sectionId].activities || {}).length > 0;
            });
            
            console.log('üìÖ Fechas con datos:', datesWithData.length);
            
            if (datesWithData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #999;">No hay registros para esta secci√≥n</p>';
                container.innerHTML = html;
                // Agregar listener al bot√≥n volver
                setTimeout(() => {
                    const btnVolver = document.getElementById('btnVolverSecciones');
                    if (btnVolver) {
                        btnVolver.addEventListener('click', renderHistorialPorSeccion);
                    }
                }, 0);
                return;
            }
            
            // Mostrar historial de la secci√≥n
            datesWithData.forEach(date => {
                const log = dailyLogs[date];
                html += `
                    <div class="report-summary" style="margin-bottom: 15px;">
                        <h3 style="color: #667eea;">üìÖ ${new Date(date).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</h3>
                `;
                
                // Actividades de esta secci√≥n en esta fecha
                const sectionActivities = activities.filter(a => a.sectionId === sectionId);
                sectionActivities.forEach(activity => {
                    const actData = log.sections[sectionId].activities;
                    
                    if (activity.frequency === '2 veces al dia') {
                        const dataMorning = actData[`${activity.id}_manana`];
                        const dataAfternoon = actData[`${activity.id}_tarde`];
                        
                        if (dataMorning && (dataMorning.value !== null || dataMorning.status !== null || dataMorning.oilLevel)) {
                            html += `<p style="margin: 8px 0;"><strong>${activity.name} (Ma√±ana):</strong> `;
                            if (activity.type === 'parametros') {
                                html += `${dataMorning.value} ${activity.unit || ''}`;
                            } else if (activity.type === 'chequeo') {
                                html += dataMorning.status === 'ok' ? '‚úì OK' : '‚úó No OK';
                            } else if (activity.type === 'nivel_aceite') {
                                html += `Nivel: ${dataMorning.oilLevel || '-'}`;
                            }
                            if (dataMorning.user) html += ` <small style="color: #666;">(${dataMorning.user})</small>`;
                            html += `</p>`;
                        }
                        
                        if (dataAfternoon && (dataAfternoon.value !== null || dataAfternoon.status !== null || dataAfternoon.oilLevel)) {
                            html += `<p style="margin: 8px 0;"><strong>${activity.name} (Tarde):</strong> `;
                            if (activity.type === 'parametros') {
                                html += `${dataAfternoon.value} ${activity.unit || ''}`;
                            } else if (activity.type === 'chequeo') {
                                html += dataAfternoon.status === 'ok' ? '‚úì OK' : '‚úó No OK';
                            } else if (activity.type === 'nivel_aceite') {
                                html += `Nivel: ${dataAfternoon.oilLevel || '-'}`;
                            }
                            if (dataAfternoon.user) html += ` <small style="color: #666;">(${dataAfternoon.user})</small>`;
                            html += `</p>`;
                        }
                    } else {
                        const activityData = actData[activity.id];
                        if (activityData && (activityData.value !== null || activityData.status !== null || activityData.oilLevel)) {
                            html += `<p style="margin: 8px 0;"><strong>${activity.name}:</strong> `;
                            if (activity.type === 'parametros') {
                                html += `${activityData.value} ${activity.unit || ''}`;
                            } else if (activity.type === 'chequeo') {
                                html += activityData.status === 'ok' ? '‚úì OK' : '‚úó No OK';
                            } else if (activity.type === 'nivel_aceite') {
                                html += `Nivel: ${activityData.oilLevel || '-'}`;
                            }
                            if (activityData.user) html += ` <small style="color: #666;">(${activityData.user})</small>`;
                            html += `</p>`;
                        }
                    }
                });
                
                // Novedades de esta secci√≥n en esta fecha
                if (novedades[date]) {
                    const seccionNovedades = novedades[date].filter(n => n.sectionId === sectionId);
                    if (seccionNovedades.length > 0) {
                        html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <h4 style="color: #ff6b6b;">üìù Novedades:</h4>`;
                        seccionNovedades.forEach(nov => {
                            html += `<p style="margin: 8px 0; color: #666;">‚Ä¢ ${nov.text}</p>`;
                        });
                        html += `</div>`;
                    }
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
            
            // Agregar event listeners despu√©s de insertar el HTML
            setTimeout(() => {
                const btnVolver = document.getElementById('btnVolverSecciones');
                if (btnVolver) {
                    btnVolver.addEventListener('click', renderHistorialPorSeccion);
                }
                
                const btnFiltrar = document.getElementById('btnFiltrarSeccion');
                if (btnFiltrar) {
                    btnFiltrar.addEventListener('click', function() {
                        const sid = parseInt(this.getAttribute('data-section-id'));
                        filtrarSeccionPorFecha(sid);
                    });
                }
            }, 0);
        }
        
        function filtrarHistorialPorFecha() {
            // Implementar filtro por rango de fechas
            alert('Filtro por fecha en desarrollo');
        }
        
        function filtrarSeccionPorFecha(sectionId) {
            // Implementar filtro por rango de fechas para secci√≥n espec√≠fica
            alert('Filtro por fecha en secci√≥n en desarrollo');
        }
        
        function renderHistorial() {
            const container = document.getElementById('historialContent');
            
            const dates = Object.keys(dailyLogs).sort().reverse();
            
            if (dates.length === 0) {
                container.innerHTML = '<p>No hay historial disponible</p>';
                return;
            }

            let html = '<div class="report-summary"><h3 style="color: #1e3c72; margin-bottom: 20px;">üìÇ Historial de Registros</h3></div>';
            
            dates.forEach(date => {
                const log = dailyLogs[date];
                let completed = 0;
                let total = 0;

                sections.forEach(section => {
                    if (log.sections && log.sections[section.id]) {
                        Object.values(log.sections[section.id].activities || {}).forEach(activity => {
                            total++;
                            if (activity.value !== null || activity.status !== null) {
                                completed++;
                            }
                        });
                    }
                });

                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

                html += `
                    <div class="report-summary" style="margin-bottom: 15px; cursor: pointer; transition: all 0.3s;" 
                         onclick="toggleHistorialDetail('${date}')"
                         onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                         onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: #1e3c72;">üìÖ ${new Date(date).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</h3>
                                <p style="margin-top: 5px; color: #666;">Completado: ${percentage}% (${completed}/${total})</p>
                            </div>
                            <div style="font-size: 24px; color: #667eea;">
                                <span id="arrow_${date}">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="detail_${date}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                            <p style="color: #666; margin-bottom: 10px;"><em>Cargando detalles...</em></p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        function toggleHistorialDetail(date) {
            const detailDiv = document.getElementById(`detail_${date}`);
            const arrow = document.getElementById(`arrow_${date}`);
            
            if (detailDiv.style.display === 'none') {
                // Mostrar detalles
                arrow.textContent = '‚ñº';
                detailDiv.style.display = 'block';
                
                // Generar contenido detallado
                let detailHTML = '';
                const log = dailyLogs[date];
                
                sections.forEach(section => {
                    const sectionActivities = activities.filter(a => a.sectionId === section.id && (a.showInSummary === 'detalle' || a.showInSummary === 'estado'));
                    
                    if (sectionActivities.length > 0 && log.sections && log.sections[section.id]) {
                        detailHTML += `<h4 style="color: #667eea; margin-top: 15px; margin-bottom: 10px;">${section.icon} ${section.name}</h4>`;
                        
                        sectionActivities.forEach(activity => {
                            if (activity.frequency === '2 veces al dia') {
                                const dataMorning = log.sections[section.id].activities[`${activity.id}_manana`];
                                const dataAfternoon = log.sections[section.id].activities[`${activity.id}_tarde`];
                                
                                if (activity.type === 'parametros') {
                                    // Manejo de par√°metros num√©ricos
                                    if (dataMorning && dataMorning.value !== null && dataMorning.value !== undefined) {
                                        const userInfo = dataMorning.user || 'Usuario';
                                        const timeInfo = dataMorning.timestamp ? new Date(dataMorning.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                        
                                        // Verificar si est√° fuera de rango
                                        const value = parseFloat(dataMorning.value);
                                        const isOutOfRange = activity.min && activity.max && (value < activity.min || value > activity.max);
                                        const alertSymbol = isOutOfRange ? '‚ö†Ô∏è ' : '';
                                        const textColor = isOutOfRange ? 'color: #dc3545; font-weight: bold;' : '';
                                        
                                        detailHTML += `<p style="margin: 5px 0; ${textColor}"><strong>${activity.name} (Ma√±ana):</strong> ${alertSymbol}${dataMorning.value} ${activity.unit || ''} <small style="color: #999;">(${userInfo} - ${timeInfo})</small></p>`;
                                    } else if (dataMorning && dataMorning.incomplete) {
                                        // Mostrar alerta de no realizada
                                        detailHTML += `<p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>${activity.name} (Ma√±ana):</strong> ‚ö†Ô∏è No realizada</p>`;
                                    }
                                    if (dataAfternoon && dataAfternoon.value !== null && dataAfternoon.value !== undefined) {
                                        const userInfo = dataAfternoon.user || 'Usuario';
                                        const timeInfo = dataAfternoon.timestamp ? new Date(dataAfternoon.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                        
                                        // Verificar si est√° fuera de rango
                                        const value = parseFloat(dataAfternoon.value);
                                        const isOutOfRange = activity.min && activity.max && (value < activity.min || value > activity.max);
                                        const alertSymbol = isOutOfRange ? '‚ö†Ô∏è ' : '';
                                        const textColor = isOutOfRange ? 'color: #dc3545; font-weight: bold;' : '';
                                        
                                        detailHTML += `<p style="margin: 5px 0; ${textColor}"><strong>${activity.name} (Tarde):</strong> ${alertSymbol}${dataAfternoon.value} ${activity.unit || ''} <small style="color: #999;">(${userInfo} - ${timeInfo})</small></p>`;
                                    } else if (dataAfternoon && dataAfternoon.incomplete) {
                                        // Mostrar alerta de no realizada
                                        detailHTML += `<p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>${activity.name} (Tarde):</strong> ‚ö†Ô∏è No realizada</p>`;
                                    }
                                } else if (activity.type === 'chequeo') {
                                    // Verificar si es Nivel de Aceite
                                    if (activity.name.toLowerCase().includes('nivel') && activity.name.toLowerCase().includes('aceite')) {
                                        // Manejo especial para Nivel de Aceite con 4 niveles
                                        if (dataMorning && dataMorning.oilLevel) {
                                            const userInfo = dataMorning.user || 'Usuario';
                                            const timeInfo = dataMorning.timestamp ? new Date(dataMorning.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                            
                                            const oilLevelText = {
                                                'full': 'üü¢ Full',
                                                '3/4': 'üü° 3/4',
                                                '1/2': 'üü† 1/2',
                                                'vacio': 'üî¥ Vac√≠o'
                                            }[dataMorning.oilLevel] || dataMorning.oilLevel;
                                            
                                            const hasAlert = dataMorning.oilLevel === '1/2' || dataMorning.oilLevel === 'vacio';
                                            const alertSymbol = hasAlert ? '‚ö†Ô∏è ' : '';
                                            const textColor = hasAlert ? 'color: #dc3545; font-weight: bold;' : '';
                                            
                                            detailHTML += `<p style="margin: 5px 0; ${textColor}"><strong>${activity.name} (Ma√±ana):</strong> ${alertSymbol}${oilLevelText} <small style="color: #999;">(${userInfo} - ${timeInfo})</small></p>`;
                                        } else if (dataMorning && dataMorning.incomplete) {
                                            // Mostrar alerta de no realizada
                                            detailHTML += `<p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>${activity.name} (Ma√±ana):</strong> ‚ö†Ô∏è No realizada</p>`;
                                        }
                                        if (dataAfternoon && dataAfternoon.oilLevel) {
                                            const userInfo = dataAfternoon.user || 'Usuario';
                                            const timeInfo = dataAfternoon.timestamp ? new Date(dataAfternoon.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                            
                                            const oilLevelText = {
                                                'full': 'üü¢ Full',
                                                '3/4': 'üü° 3/4',
                                                '1/2': 'üü† 1/2',
                                                'vacio': 'üî¥ Vac√≠o'
                                            }[dataAfternoon.oilLevel] || dataAfternoon.oilLevel;
                                            
                                            const hasAlert = dataAfternoon.oilLevel === '1/2' || dataAfternoon.oilLevel === 'vacio';
                                            const alertSymbol = hasAlert ? '‚ö†Ô∏è ' : '';
                                            const textColor = hasAlert ? 'color: #dc3545; font-weight: bold;' : '';
                                            
                                            detailHTML += `<p style="margin: 5px 0; ${textColor}"><strong>${activity.name} (Tarde):</strong> ${alertSymbol}${oilLevelText} <small style="color: #999;">(${userInfo} - ${timeInfo})</small></p>`;
                                        } else if (dataAfternoon && dataAfternoon.incomplete) {
                                            // Mostrar alerta de no realizada
                                            detailHTML += `<p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>${activity.name} (Tarde):</strong> ‚ö†Ô∏è No realizada</p>`;
                                        }
                                    } else {
                                        // Manejo de chequeos normales (OK/No OK)
                                        if (dataMorning && dataMorning.status === 'ok') {
                                            const userInfo = dataMorning.user || 'Usuario';
                                            const timeInfo = dataMorning.timestamp ? new Date(dataMorning.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                            
                                            detailHTML += `<p style="margin: 5px 0;"><strong>${activity.name} (Ma√±ana):</strong> ‚úì OK <small style="color: #999;">(${userInfo} - ${timeInfo})</small></p>`;
                                        } else if (dataMorning && dataMorning.incomplete) {
                                            // Mostrar alerta de no realizada
                                            detailHTML += `<p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>${activity.name} (Ma√±ana):</strong> ‚ö†Ô∏è No realizada</p>`;
                                        }
                                        if (dataAfternoon && dataAfternoon.status === 'ok') {
                                            const userInfo = dataAfternoon.user || 'Usuario';
                                            const timeInfo = dataAfternoon.timestamp ? new Date(dataAfternoon.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                                            
                                            detailHTML += `<p style="margin: 5px 0;"><strong>${activity.name} (Tarde):</strong> ‚úì OK <small style="color: #999;">(${userInfo} - ${timeInfo})</small></p>`;
                                        } else if (dataAfternoon && dataAfternoon.incomplete) {
                                            // Mostrar alerta de no realizada
                                            detailHTML += `<p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>${activity.name} (Tarde):</strong> ‚ö†Ô∏è No realizada</p>`;
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Mostrar novedades
                if (log.novedades && log.novedades.length > 0) {
                    detailHTML += `<h4 style="color: #667eea; margin-top: 15px; margin-bottom: 10px;">üìù Novedades</h4>`;
                    log.novedades.forEach((novedad, index) => {
                        const photoIcon = novedad.photos && novedad.photos.length > 0 
                            ? ` <span style="cursor: pointer; color: #667eea;" onclick="openHistorialPhotoCarousel('${date}', ${index})">üì∑(${novedad.photos.length})</span>` 
                            : '';
                        detailHTML += `<p style="margin: 5px 0;">‚Ä¢ ${novedad.text}${photoIcon} <small style="color: #999;">(${novedad.user})</small></p>`;
                    });
                }
                
                if (detailHTML === '') {
                    detailHTML = '<p style="color: #999;"><em>No hay detalles registrados para este d√≠a</em></p>';
                }
                
                detailDiv.innerHTML = detailHTML;
            } else {
                // Ocultar detalles
                arrow.textContent = '‚ñ∂';
                detailDiv.style.display = 'none';
            }
        }

        // ==================== CONFIGURACI√ìN ====================
        
        function renderConfiguracion() {
            const container = document.getElementById('configContent');
            
            container.innerHTML = `
                <div class="report-summary">
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">‚öôÔ∏è Panel de Configuraci√≥n</h3>
                    
                    <!-- Tabs de configuraci√≥n -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                        <button onclick="showConfigTab('users')" id="configTabUsers" 
                                style="padding: 10px 20px; background: #667eea; color: white; border: none; 
                                       border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px;">
                            üë• Usuarios
                        </button>
                        <button onclick="showConfigTab('sections')" id="configTabSections"
                                style="padding: 10px 20px; background: #ddd; color: #666; border: none; 
                                       border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px;">
                            üìä Secciones
                        </button>
                        <button onclick="showConfigTab('activities')" id="configTabActivities"
                                style="padding: 10px 20px; background: #ddd; color: #666; border: none; 
                                       border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px;">
                            üìã Actividades
                        </button>
                        <button onclick="showConfigTab('novedades')" id="configTabNovedades"
                                style="padding: 10px 20px; background: #ddd; color: #666; border: none; 
                                       border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px;">
                            üìù Novedades
                        </button>
                    </div>
                    
                    <!-- Contenido de tabs -->
                    <div id="configTabContent"></div>
                </div>
            `;
            
            // Mostrar tab de usuarios por defecto
            showConfigTab('users');
        }
        
        function showConfigTab(tabName) {
            // Actualizar botones
            ['users', 'sections', 'activities', 'novedades'].forEach(tab => {
                const btn = document.getElementById(`configTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                if (tab === tabName) {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#ddd';
                    btn.style.color = '#666';
                }
            });
            
            // Mostrar contenido
            const content = document.getElementById('configTabContent');
            
            switch(tabName) {
                case 'users':
                    renderUsersConfig(content);
                    break;
                case 'sections':
                    renderSectionsConfig(content);
                    break;
                case 'activities':
                    renderActivitiesConfig(content);
                    break;
                case 'novedades':
                    renderNovedadesConfig(content);
                    break;
            }
        }
        
        function renderUsersConfig(container) {
            let html = '<h4 style="color: #2a5298; margin-bottom: 15px;">Gesti√≥n de Usuarios</h4>';
            
            users.forEach(user => {
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${user.fullName}</strong>
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Usuario: ${user.username} | Rol: ${user.role}
                                </p>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="openEditUserModal(${user.id})" 
                                        style="background: #667eea; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteUser(${user.id}, '${user.fullName}')" 
                                        style="background: #dc3545; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button onclick="openAddUserModal()" 
                        style="background: #28a745; color: white; border: none; 
                               padding: 10px 20px; border-radius: 5px; cursor: pointer; 
                               font-size: 14px; margin-top: 15px; width: 100%;">
                    ‚ûï Agregar Usuario
                </button>
            `;
            
            container.innerHTML = html;
        }
        
        // ==================== GESTI√ìN DE USUARIOS ====================
        
        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            // Limpiar campos
            document.getElementById('newUserFullName').value = '';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserRole').value = '';
            // Limpiar checkboxes de pesta√±as
            document.getElementById('newUserCanViewReporte').checked = false;
            document.getElementById('newUserCanViewMantenimiento').checked = false;
            document.getElementById('newUserCanViewPlan').checked = false;
            document.getElementById('newUserCanViewHistorial').checked = false;
            document.getElementById('newUserCanViewConfig').checked = false;
            // Limpiar permiso especial
            document.getElementById('newUserCanApprovePlan').checked = false;
        }
        
        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }
        
        async function saveNewUser() {
            const fullName = document.getElementById('newUserFullName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            // Leer permisos de pesta√±as
            const canViewReporte = document.getElementById('newUserCanViewReporte').checked;
            const canViewMantenimiento = document.getElementById('newUserCanViewMantenimiento').checked;
            const canViewPlan = document.getElementById('newUserCanViewPlan').checked;
            const canViewHistorial = document.getElementById('newUserCanViewHistorial').checked;
            const canViewConfig = document.getElementById('newUserCanViewConfig').checked;
            const canApprovePlan = document.getElementById('newUserCanApprovePlan').checked;
            
            // Validaciones
            if (!fullName) {
                alert('‚ö†Ô∏è Ingresa el nombre completo');
                return;
            }
            
            if (!username) {
                alert('‚ö†Ô∏è Ingresa un nombre de usuario');
                return;
            }
            
            if (!/^[a-z0-9]+$/.test(username)) {
                alert('‚ö†Ô∏è El usuario solo puede contener letras min√∫sculas y n√∫meros');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                alert('‚ö†Ô∏è Este usuario ya existe');
                return;
            }
            
            if (!password || password.length < 6) {
                alert('‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            if (!role) {
                alert('‚ö†Ô∏è Selecciona un rol');
                return;
            }
            
            // Construir array de permisos basado en checkboxes
            const permissions = [];
            
            // Admin y Supervisor tienen todos los permisos autom√°ticamente
            if (role === 'admin' || role === 'supervisor') {
                permissions.push('reporte-diario', 'mantenimiento-preventivo', 'plan', 'historial', 'configuracion');
            } else {
                // Operadores y otros roles: usar checkboxes
                if (canViewReporte) permissions.push('reporte-diario');
                if (canViewMantenimiento) permissions.push('mantenimiento-preventivo');
                if (canViewPlan) permissions.push('plan');
                if (canViewHistorial) permissions.push('historial');
                if (canViewConfig) permissions.push('configuracion');
            }
            
            // Crear nuevo usuario
            const newId = Math.max(...users.map(u => u.id), 0) + 1;
            
            const newUser = {
                id: newId,
                username: username,
                password: password,
                fullName: fullName,
                role: role,
                permissions: permissions,
                planPermissions: {
                    canView: permissions.includes('plan'),
                    canApprove: canApprovePlan || role === 'admin' || role === 'supervisor'
                }
            };
            
            try {
                showSyncIndicator('üíæ Creando usuario...', 'syncing');
                users.push(newUser);
                await usersRef.set(users);
                showSyncIndicator('‚úì Usuario creado exitosamente', 'synced');
                closeAddUserModal();
                renderConfiguracion();
            } catch (error) {
                console.error('Error al crear usuario:', error);
                showSyncIndicator('‚úó Error al crear usuario', 'error');
            }
        }
        
        function openEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserFullName').value = user.fullName;
            document.getElementById('editUserUsername').value = user.username;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserRole').value = user.role;
            
            // Cargar permisos de pesta√±as
            document.getElementById('editUserCanViewReporte').checked = user.permissions.includes('reporte-diario');
            document.getElementById('editUserCanViewMantenimiento').checked = user.permissions.includes('mantenimiento-preventivo');
            document.getElementById('editUserCanViewPlan').checked = user.permissions.includes('plan');
            document.getElementById('editUserCanViewHistorial').checked = user.permissions.includes('historial');
            document.getElementById('editUserCanViewConfig').checked = user.permissions.includes('configuracion');
            
            // Cargar permiso especial
            const canApprove = user.planPermissions?.canApprove || false;
            document.getElementById('editUserCanApprovePlan').checked = canApprove;
            
            document.getElementById('editUserModal').style.display = 'block';
        }
        
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }
        
        async function saveEditedUser() {
            const userId = parseInt(document.getElementById('editUserId').value);
            const fullName = document.getElementById('editUserFullName').value.trim();
            const username = document.getElementById('editUserUsername').value.trim().toLowerCase();
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;
            
            // Leer permisos de pesta√±as
            const canViewReporte = document.getElementById('editUserCanViewReporte').checked;
            const canViewMantenimiento = document.getElementById('editUserCanViewMantenimiento').checked;
            const canViewPlan = document.getElementById('editUserCanViewPlan').checked;
            const canViewHistorial = document.getElementById('editUserCanViewHistorial').checked;
            const canViewConfig = document.getElementById('editUserCanViewConfig').checked;
            const canApprovePlan = document.getElementById('editUserCanApprovePlan').checked;
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                alert('Usuario no encontrado');
                return;
            }
            
            // Validaciones
            if (!fullName) {
                alert('‚ö†Ô∏è Ingresa el nombre completo');
                return;
            }
            
            if (!username) {
                alert('‚ö†Ô∏è Ingresa un nombre de usuario');
                return;
            }
            
            if (!/^[a-z0-9]+$/.test(username)) {
                alert('‚ö†Ô∏è El usuario solo puede contener letras min√∫sculas y n√∫meros');
                return;
            }
            
            // Verificar que no exista otro usuario con ese username
            const existingUser = users.find(u => u.username === username && u.id !== userId);
            if (existingUser) {
                alert('‚ö†Ô∏è Ese usuario ya existe');
                return;
            }
            
            if (password && password.length < 6) {
                alert('‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            // Construir array de permisos basado en checkboxes
            const permissions = [];
            
            // Admin y Supervisor tienen todos los permisos autom√°ticamente
            if (role === 'admin' || role === 'supervisor') {
                permissions.push('reporte-diario', 'mantenimiento-preventivo', 'plan', 'historial', 'configuracion');
            } else {
                // Operadores y otros roles: usar checkboxes
                if (canViewReporte) permissions.push('reporte-diario');
                if (canViewMantenimiento) permissions.push('mantenimiento-preventivo');
                if (canViewPlan) permissions.push('plan');
                if (canViewHistorial) permissions.push('historial');
                if (canViewConfig) permissions.push('configuracion');
            }
            
            // Actualizar usuario
            users[userIndex].fullName = fullName;
            users[userIndex].username = username;
            if (password) {
                users[userIndex].password = password;
            }
            users[userIndex].role = role;
            users[userIndex].permissions = permissions;
            users[userIndex].planPermissions = {
                canView: permissions.includes('plan'),
                canApprove: canApprovePlan || role === 'admin' || role === 'supervisor'
            };
            
            try {
                showSyncIndicator('üíæ Guardando cambios...', 'syncing');
                await usersRef.set(users);
                showSyncIndicator('‚úì Usuario actualizado', 'synced');
                closeEditUserModal();
                renderConfiguracion();
            } catch (error) {
                console.error('Error al actualizar usuario:', error);
                showSyncIndicator('‚úó Error al actualizar', 'error');
            }
        }
        
        async function deleteUser(userId, fullName) {
            if (!confirm(`¬øEliminar al usuario "${fullName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                alert('Usuario no encontrado');
                return;
            }
            
            try {
                showSyncIndicator('üóëÔ∏è Eliminando usuario...', 'syncing');
                users.splice(userIndex, 1);
                await usersRef.set(users);
                showSyncIndicator('‚úì Usuario eliminado', 'synced');
                renderConfiguracion();
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                showSyncIndicator('‚úó Error al eliminar', 'error');
            }
        }
        
        function renderSectionsConfig(container) {
            let html = '<h4 style="color: #2a5298; margin-bottom: 15px;">Gesti√≥n de Secciones</h4>';
            
            sections.forEach((section, index) => {
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${section.icon} ${section.name}</strong>
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Orden: ${section.order}
                                </p>
                            </div>
                            <div>
                                <button onclick="moveSectionUp(${section.id})" 
                                        ${index === 0 ? 'disabled style="opacity: 0.3;"' : ''}
                                        style="background: #667eea; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px; margin-right: 5px;">
                                    ‚Üë
                                </button>
                                <button onclick="moveSectionDown(${section.id})" 
                                        ${index === sections.length - 1 ? 'disabled style="opacity: 0.3;"' : ''}
                                        style="background: #667eea; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px; margin-right: 5px;">
                                    ‚Üì
                                </button>
                                <button onclick="editSection(${section.id})" 
                                        style="background: #ffc107; color: #000; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px; margin-right: 5px;">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteSection(${section.id})" 
                                        style="background: #dc3545; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button onclick="promptAddSection()" 
                        style="background: #28a745; color: white; border: none; 
                               padding: 10px 20px; border-radius: 5px; cursor: pointer; 
                               font-size: 14px; margin-top: 15px; width: 100%;">
                    ‚ûï Agregar Secci√≥n
                </button>
            `;
            
            container.innerHTML = html;
        }
        
        function promptAddSection() {
            // Abrir modal en lugar de prompts
            document.getElementById('newSectionName').value = '';
            document.getElementById('newSectionIcon').value = 'üì¶';
            document.getElementById('newSectionShowInSummary').value = 'resumido';
            document.getElementById('addSectionModal').style.display = 'flex';
        }
        
        function closeAddSectionModal() {
            document.getElementById('addSectionModal').style.display = 'none';
        }
        
        async function saveNewSection() {
            const name = document.getElementById('newSectionName').value.trim();
            const icon = document.getElementById('newSectionIcon').value.trim();
            const showInSummary = document.getElementById('newSectionShowInSummary').value;
            
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }
            
            if (!icon) {
                alert('El √≠cono es obligatorio');
                return;
            }
            
            const newId = Math.max(...sections.map(s => s.id), 0) + 1;
            const newOrder = Math.max(...sections.map(s => s.order), 0) + 1;
            
            console.log(`‚ûï Creando nueva secci√≥n: ${name} (id:${newId}, order:${newOrder}, showInSummary:${showInSummary})`);
            
            const newSection = {
                id: newId,
                name: name,
                icon: icon,
                order: newOrder,
                showInSummary: showInSummary
            };
            
            sections.push(newSection);
            sections.sort((a, b) => a.order - b.order);
            
            await sectionsRef.set(sections);
            console.log('‚úÖ Secci√≥n guardada en Firebase');
            
            // Inicializar la nueva secci√≥n en todos los dailyLogs existentes
            console.log(`üîß Inicializando secci√≥n en ${Object.keys(dailyLogs).length} d√≠as...`);
            
            for (const [date, log] of Object.entries(dailyLogs)) {
                if (!log.sections) {
                    log.sections = {};
                }
                
                if (!log.sections[newId]) {
                    console.log(`  ‚ûï Agregando secci√≥n id:${newId} al d√≠a ${date}`);
                    log.sections[newId] = {
                        activities: {},
                        photos: []
                    };
                }
            }
            
            // Guardar dailyLogs actualizados
            await dailyLogsRef.set(dailyLogs);
            console.log('‚úÖ DailyLogs actualizados en Firebase');
            
            // Recargar datos desde Firebase para asegurar sincronizaci√≥n
            await loadDataFromFirebase();
            console.log('‚úÖ Datos recargados desde Firebase');
            
            showSyncIndicator('‚úì Secci√≥n agregada', 'synced');
            closeAddSectionModal();
            renderConfiguracion();
            renderSections(); // Re-renderizar para mostrar la nueva secci√≥n
        }
        
        let currentEditSectionId = null;
        
        function editSection(sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;
            
            currentEditSectionId = sectionId;
            
            // Cargar datos de la secci√≥n en el modal
            document.getElementById('editSectionName').value = section.name;
            document.getElementById('editSectionIcon').value = section.icon;
            document.getElementById('editSectionShowInSummary').value = section.showInSummary || 'resumido';
            
            // Abrir modal
            document.getElementById('editSectionModal').style.display = 'flex';
        }
        
        function closeEditSectionModal() {
            document.getElementById('editSectionModal').style.display = 'none';
            currentEditSectionId = null;
        }
        
        async function saveEditedSection() {
            if (!currentEditSectionId) return;
            
            const section = sections.find(s => s.id === currentEditSectionId);
            if (!section) return;
            
            const name = document.getElementById('editSectionName').value.trim();
            const icon = document.getElementById('editSectionIcon').value.trim();
            const showInSummary = document.getElementById('editSectionShowInSummary').value;
            
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }
            
            if (!icon) {
                alert('El √≠cono es obligatorio');
                return;
            }
            
            // Actualizar la secci√≥n
            section.name = name;
            section.icon = icon;
            section.showInSummary = showInSummary;
            
            // Guardar en Firebase
            await sectionsRef.set(sections);
            console.log('‚úÖ Secci√≥n actualizada en Firebase');
            
            showSyncIndicator('‚úì Secci√≥n actualizada', 'synced');
            closeEditSectionModal();
            renderConfiguracion();
            renderSections(); // Re-renderizar para mostrar los cambios
        }
        
        async function deleteSection(id) {
            const section = sections.find(s => s.id === id);
            if (!section) return;
            
            if (!confirm(`¬øEliminar la secci√≥n "${section.name}" y todas sus actividades?`)) return;
            
            // Eliminar actividades de esta secci√≥n
            activities = activities.filter(a => a.sectionId !== id);
            await activitiesRef.set(activities);
            
            // Eliminar secci√≥n
            sections = sections.filter(s => s.id !== id);
            await sectionsRef.set(sections);
            
            showSyncIndicator('‚úì Secci√≥n eliminada', 'synced');
            renderConfiguracion();
        }
        
        async function moveSectionUp(id) {
            const index = sections.findIndex(s => s.id === id);
            if (index <= 0) return;
            
            // Intercambiar order con secci√≥n anterior
            const temp = sections[index].order;
            sections[index].order = sections[index - 1].order;
            sections[index - 1].order = temp;
            
            sections.sort((a, b) => a.order - b.order);
            await sectionsRef.set(sections);
            
            showSyncIndicator('‚úì Orden actualizado', 'synced');
            renderConfiguracion();
            renderSections();
        }
        
        async function moveSectionDown(id) {
            const index = sections.findIndex(s => s.id === id);
            if (index < 0 || index >= sections.length - 1) return;
            
            // Intercambiar order con secci√≥n siguiente
            const temp = sections[index].order;
            sections[index].order = sections[index + 1].order;
            sections[index + 1].order = temp;
            
            sections.sort((a, b) => a.order - b.order);
            await sectionsRef.set(sections);
            
            showSyncIndicator('‚úì Orden actualizado', 'synced');
            renderConfiguracion();
            renderSections();
        }
        
        function renderActivitiesConfig(container) {
            let html = '<h4 style="color: #2a5298; margin-bottom: 15px;">Gesti√≥n de Actividades</h4>';
            
            // Agrupar por secci√≥n y ordenar
            const sortedSections = [...sections].sort((a, b) => a.order - b.order);
            
            sortedSections.forEach(section => {
                const sectionActivities = activities
                    .filter(a => a.sectionId === section.id)
                    .sort((a, b) => a.order - b.order); // Ordenar por order
                
                if (sectionActivities.length > 0) {
                    html += `<h5 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">${section.icon} ${section.name}</h5>`;
                    
                    sectionActivities.forEach((activity, index) => {
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 8px; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <strong style="font-size: 13px;">${activity.name}</strong>
                                        <p style="font-size: 11px; color: #666; margin-top: 3px;">
                                            Tipo: ${activity.type} | Frecuencia: ${activity.frequency}
                                            ${activity.min !== null && activity.min !== undefined ? ` | Min: ${activity.min}` : ''}
                                            ${activity.max !== null && activity.max !== undefined ? ` | Max: ${activity.max}` : ''}
                                        </p>
                                    </div>
                                    <div style="white-space: nowrap;">
                                        <button onclick="moveActivityUp(${activity.id})" 
                                                ${index === 0 ? 'disabled style="opacity: 0.3;"' : ''}
                                                style="background: #667eea; color: white; border: none; 
                                                       padding: 4px 8px; border-radius: 3px; cursor: pointer; 
                                                       font-size: 11px; margin-right: 3px;">
                                            ‚Üë
                                        </button>
                                        <button onclick="moveActivityDown(${activity.id})" 
                                                ${index === sectionActivities.length - 1 ? 'disabled style="opacity: 0.3;"' : ''}
                                                style="background: #667eea; color: white; border: none; 
                                                       padding: 4px 8px; border-radius: 3px; cursor: pointer; 
                                                       font-size: 11px; margin-right: 3px;">
                                            ‚Üì
                                        </button>
                                        <button onclick="editActivity(${activity.id})" 
                                                style="background: #ffc107; color: white; border: none; 
                                                       padding: 4px 8px; border-radius: 3px; cursor: pointer; 
                                                       font-size: 11px; margin-right: 3px;">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="deleteActivity(${activity.id})" 
                                                style="background: #dc3545; color: white; border: none; 
                                                       padding: 4px 8px; border-radius: 3px; cursor: pointer; 
                                                       font-size: 11px;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
            
            html += `
                <button onclick="promptAddActivity()" 
                        style="background: #28a745; color: white; border: none; 
                               padding: 10px 20px; border-radius: 5px; cursor: pointer; 
                               font-size: 14px; margin-top: 15px; width: 100%;">
                    ‚ûï Agregar Actividad
                </button>
            `;
            
            container.innerHTML = html;
        }
        
        function promptAddActivity() {
            // Abrir modal
            const modal = document.getElementById('addActivityModal');
            modal.style.display = 'block';
            
            // Llenar selector de secciones
            const sectionSelect = document.getElementById('activitySection');
            sectionSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            sections.forEach(section => {
                sectionSelect.innerHTML += `<option value="${section.id}">${section.icon} ${section.name}</option>`;
            });
            
            // Limpiar campos
            document.getElementById('activityName').value = '';
            document.getElementById('activityType').value = '';
            document.getElementById('activityUnit').value = '';
            document.getElementById('activityMin').value = '';
            document.getElementById('activityMax').value = '';
            document.getElementById('activityFrequency').value = '';
            document.getElementById('parametrosFields').style.display = 'none';
        }
        
        function closeAddActivityModal() {
            document.getElementById('addActivityModal').style.display = 'none';
        }
        
        function toggleActivityFields() {
            const type = document.getElementById('activityType').value;
            const parametrosFields = document.getElementById('parametrosFields');
            parametrosFields.style.display = type === 'parametros' ? 'block' : 'none';
        }
        
        async function saveNewActivity() {
            const sectionId = parseInt(document.getElementById('activitySection').value);
            const name = document.getElementById('activityName').value.trim();
            const type = document.getElementById('activityType').value;
            const frequency = document.getElementById('activityFrequency').value;
            
            // Validaciones
            if (!sectionId) {
                alert('Por favor selecciona una secci√≥n');
                return;
            }
            
            if (!name) {
                alert('Por favor escribe el nombre de la actividad');
                return;
            }
            
            if (!type) {
                alert('Por favor selecciona el tipo de registro');
                return;
            }
            
            if (!frequency) {
                alert('Por favor selecciona la frecuencia');
                return;
            }
            
            const section = sections.find(s => s.id === sectionId);
            if (!section) {
                alert('Secci√≥n no encontrada');
                return;
            }
            
            let unit = null, min = null, max = null;
            
            if (type === 'parametros') {
                unit = document.getElementById('activityUnit').value.trim() || '';
                const minStr = document.getElementById('activityMin').value;
                const maxStr = document.getElementById('activityMax').value;
                min = minStr ? parseFloat(minStr) : null;
                max = maxStr ? parseFloat(maxStr) : null;
            }
            
            // Crear actividad
            const newId = Math.max(...activities.map(a => a.id), 0) + 1;
            const newOrder = Math.max(...activities.filter(a => a.sectionId === section.id).map(a => a.order), 0) + 1;
            
            const newActivity = {
                id: newId,
                sectionId: section.id,
                name: name,
                type: type,
                frequency: frequency,
                unit: unit,
                min: min,
                max: max,
                order: newOrder,
                showInSummary: 'detalle'
            };
            
            activities.push(newActivity);
            await activitiesRef.set(activities);
            
            // CORRECCI√ìN: Inicializar la nueva actividad en el dailyLog actual
            if (!dailyLogs[currentDate].sections[section.id]) {
                dailyLogs[currentDate].sections[section.id] = { activities: {} };
            }
            
            if (frequency === '2 veces al dia') {
                // Inicializar turnos ma√±ana y tarde
                dailyLogs[currentDate].sections[section.id].activities[`${newId}_manana`] = {
                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                };
                dailyLogs[currentDate].sections[section.id].activities[`${newId}_tarde`] = {
                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                };
            } else {
                // Inicializar actividad √∫nica
                dailyLogs[currentDate].sections[section.id].activities[newId] = {
                    value: null, status: null, oilLevel: null, observations: '', photos: [], user: null, timestamp: null
                };
            }
            
            // Guardar en Firebase
            await database.ref(`dailyLogs/${currentDate}`).set(dailyLogs[currentDate]);
            
            showSyncIndicator('‚úì Actividad agregada', 'synced');
            closeAddActivityModal();
            renderConfiguracion();
            renderSections(); // Re-renderizar secciones para mostrar la nueva actividad
        }
        
        function renderNovedadesConfig(container) {
            let html = '<h4 style="color: #2a5298; margin-bottom: 15px;">Novedades Predefinidas</h4>';
            
            novedadesPredefinidas.forEach((novedad, index) => {
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <strong>${novedad.text}</strong>
                            </div>
                            <div>
                                <button onclick="moveNovedadUp(${novedad.id})" 
                                        ${index === 0 ? 'disabled style="opacity: 0.3;"' : ''}
                                        style="background: #667eea; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px; margin-right: 5px;">
                                    ‚Üë
                                </button>
                                <button onclick="moveNovedadDown(${novedad.id})" 
                                        ${index === novedadesPredefinidas.length - 1 ? 'disabled style="opacity: 0.3;"' : ''}
                                        style="background: #667eea; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px; margin-right: 5px;">
                                    ‚Üì
                                </button>
                                <button onclick="deleteNovedad(${novedad.id})" 
                                        style="background: #dc3545; color: white; border: none; 
                                               padding: 6px 12px; border-radius: 5px; cursor: pointer; 
                                               font-size: 12px;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button onclick="promptAddNovedad()" 
                        style="background: #28a745; color: white; border: none; 
                               padding: 10px 20px; border-radius: 5px; cursor: pointer; 
                               font-size: 14px; margin-top: 15px; width: 100%;">
                    ‚ûï Agregar Novedad
                </button>
            `;
            
            container.innerHTML = html;
        }
        
        async function moveNovedadUp(id) {
            const index = novedadesPredefinidas.findIndex(n => n.id === id);
            if (index <= 0) return;
            
            // Intercambiar posiciones
            const temp = novedadesPredefinidas[index];
            novedadesPredefinidas[index] = novedadesPredefinidas[index - 1];
            novedadesPredefinidas[index - 1] = temp;
            
            await novedadesPredefinidasRef.set(novedadesPredefinidas);
            showSyncIndicator('‚úì Orden actualizado', 'synced');
            renderConfiguracion();
        }
        
        async function moveNovedadDown(id) {
            const index = novedadesPredefinidas.findIndex(n => n.id === id);
            if (index < 0 || index >= novedadesPredefinidas.length - 1) return;
            
            // Intercambiar posiciones
            const temp = novedadesPredefinidas[index];
            novedadesPredefinidas[index] = novedadesPredefinidas[index + 1];
            novedadesPredefinidas[index + 1] = temp;
            
            await novedadesPredefinidasRef.set(novedadesPredefinidas);
            showSyncIndicator('‚úì Orden actualizado', 'synced');
            renderConfiguracion();
        }
        
        async function promptAddNovedad() {
            const text = prompt('Escribe el texto de la nueva novedad:');
            if (text && text.trim()) {
                const newId = Math.max(...novedadesPredefinidas.map(n => n.id), 0) + 1;
                const newNovedad = { id: newId, text: text.trim() };
                novedadesPredefinidas.push(newNovedad);
                
                await novedadesPredefinidasRef.set(novedadesPredefinidas);
                showSyncIndicator('‚úì Novedad agregada', 'synced');
                renderConfiguracion();
            }
        }
        
        async function deleteNovedad(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta novedad?')) {
                novedadesPredefinidas = novedadesPredefinidas.filter(n => n.id !== id);
                await novedadesPredefinidasRef.set(novedadesPredefinidas);
                showSyncIndicator('‚úì Novedad eliminada', 'synced');
                renderConfiguracion();
            }
        }
        
        async function moveActivityUp(activityId) {
            const activity = activities.find(a => a.id === activityId);
            if (!activity) return;
            
            // Obtener actividades de la misma secci√≥n
            const sectionActivities = activities
                .filter(a => a.sectionId === activity.sectionId)
                .sort((a, b) => a.order - b.order);
            
            const index = sectionActivities.findIndex(a => a.id === activityId);
            if (index <= 0) return;
            
            // Intercambiar order con actividad anterior
            const temp = sectionActivities[index].order;
            sectionActivities[index].order = sectionActivities[index - 1].order;
            sectionActivities[index - 1].order = temp;
            
            await activitiesRef.set(activities);
            showSyncIndicator('‚úì Orden actualizado', 'synced');
            renderConfiguracion();
        }
        
        async function moveActivityDown(activityId) {
            const activity = activities.find(a => a.id === activityId);
            if (!activity) return;
            
            // Obtener actividades de la misma secci√≥n
            const sectionActivities = activities
                .filter(a => a.sectionId === activity.sectionId)
                .sort((a, b) => a.order - b.order);
            
            const index = sectionActivities.findIndex(a => a.id === activityId);
            if (index < 0 || index >= sectionActivities.length - 1) return;
            
            // Intercambiar order con actividad siguiente
            const temp = sectionActivities[index].order;
            sectionActivities[index].order = sectionActivities[index + 1].order;
            sectionActivities[index + 1].order = temp;
            
            await activitiesRef.set(activities);
            showSyncIndicator('‚úì Orden actualizado', 'synced');
            renderConfiguracion();
        }
        
        async function deleteActivity(activityId) {
            const activity = activities.find(a => a.id === activityId);
            if (!activity) return;
            
            if (!confirm(`¬øEliminar la actividad "${activity.name}"?`)) return;
            
            activities = activities.filter(a => a.id !== activityId);
            await activitiesRef.set(activities);
            
            showSyncIndicator('‚úì Actividad eliminada', 'synced');
            renderConfiguracion();
        }
        
        async function editActivity(activityId) {
            const activity = activities.find(a => a.id === activityId);
            if (!activity) return;
            
            // Editar nombre
            const newName = prompt('Nombre de la actividad:', activity.name);
            if (!newName || newName.trim() === '') return;
            
            activity.name = newName.trim();
            
            // Si es par√°metros, permitir editar rango
            if (activity.type === 'parametros') {
                const newUnit = prompt('Unidad:', activity.unit || '');
                const newMin = prompt('Valor m√≠nimo:', activity.min !== null && activity.min !== undefined ? activity.min : '');
                const newMax = prompt('Valor m√°ximo:', activity.max !== null && activity.max !== undefined ? activity.max : '');
                
                activity.unit = newUnit ? newUnit.trim() : '';
                activity.min = newMin !== '' ? parseFloat(newMin) : null;
                activity.max = newMax !== '' ? parseFloat(newMax) : null;
            }
            
            await activitiesRef.set(activities);
            showSyncIndicator('‚úì Actividad editada', 'synced');
            renderConfiguracion();
        }

        // ==================== INITIALIZE APP ====================
        
        window.addEventListener('load', async function() {
            console.log('üöÄ App starting...');
            
            // Initialize Firebase first
            const firebaseReady = await initializeFirebase();
            
            if (!firebaseReady) {
                document.getElementById('loginLoading').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="color: #dc3545; margin-bottom: 15px;">‚ùå Error al cargar Firebase</h3>
                        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                            No se pudo conectar con la base de datos en la nube.
                        </p>
                        <p style="font-size: 12px; color: #999; margin-bottom: 20px;">
                            Posibles causas:<br>
                            ‚Ä¢ Problemas de conexi√≥n a internet<br>
                            ‚Ä¢ Firewall o bloqueador de anuncios activo<br>
                            ‚Ä¢ Restricciones de red corporativa
                        </p>
                        <button onclick="location.reload()" class="btn" style="margin-top: 15px;">üîÑ Reintentar</button>
                        <p style="font-size: 10px; color: #ccc; margin-top: 15px;">
                            Si el problema persiste, intenta desactivar extensiones del navegador o usar otro navegador.
                        </p>
                    </div>
                `;
                return;
            }
            
            await initializeFirebaseData();
            setupRealTimeSync();
            
            // Check for saved session AFTER data is loaded
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && users.length > 0) {
                const savedUserData = JSON.parse(savedUser);
                const updatedUser = users.find(u => u.id === savedUserData.id);
                if (updatedUser) {
                    currentUser = updatedUser;
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    showMainScreen();
                }
            }
            
            console.log('‚úÖ App ready!');
            
            // Iniciar verificaci√≥n peri√≥dica de cambio de d√≠a
            startDailyRenewal();
        });
        
        // ==================== RENOVACI√ìN AUTOM√ÅTICA DIARIA ====================
        
        async function checkAndRenewDay() {
            const newDate = getOperationalDate();
            
            if (newDate !== currentDate) {
                console.log(`üîÑ Cambio de d√≠a detectado: ${currentDate} ‚Üí ${newDate}`);
                
                // Marcar actividades no completadas del d√≠a anterior
                await markIncompleteActivities(currentDate);
                
                // Actualizar fecha actual
                currentDate = newDate;
                
                // Inicializar estructura para el nuevo d√≠a
                await initializeDailyStructure();
                
                // Refrescar interfaz
                if (currentUser) {
                    renderSections();
                    renderReporteDiario();
                }
                
                console.log(`‚úÖ D√≠a renovado: ${currentDate}`);
            }
        }
        
        async function markIncompleteActivities(date) {
            if (!dailyLogs[date]) return;
            
            console.log(`‚ö†Ô∏è Marcando actividades no completadas del ${date}`);
            
            const notCompletedList = [];
            
            sections.forEach(section => {
                if (!dailyLogs[date].sections || !dailyLogs[date].sections[section.id]) return;
                
                const sectionActivities = activities.filter(a => a.sectionId === section.id);
                
                sectionActivities.forEach(activity => {
                    if (activity.frequency === '2 veces al dia') {
                        // Verificar turno ma√±ana
                        const activityKeyMorning = `${activity.id}_manana`;
                        const dataMorning = dailyLogs[date].sections[section.id].activities[activityKeyMorning];
                        
                        if (dataMorning) {
                            const isComplete = (activity.type === 'parametros' && dataMorning.value !== null) || 
                                             (activity.type === 'chequeo' && (dataMorning.status === 'ok' || dataMorning.oilLevel));
                            
                            if (!isComplete) {
                                dailyLogs[date].sections[section.id].activities[activityKeyMorning].incomplete = true;
                                dailyLogs[date].sections[section.id].activities[activityKeyMorning].incompleteAlert = '‚ö†Ô∏è No realizada';
                                
                                // Registrar en lista de no completadas
                                notCompletedList.push({
                                    id: Date.now() + Math.random(),
                                    date: date,
                                    sectionId: section.id,
                                    sectionName: section.name,
                                    activityId: activity.id,
                                    activityName: `${activity.name} (Ma√±ana)`,
                                    activityType: activity.type,
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                        
                        // Verificar turno tarde
                        const activityKeyAfternoon = `${activity.id}_tarde`;
                        const dataAfternoon = dailyLogs[date].sections[section.id].activities[activityKeyAfternoon];
                        
                        if (dataAfternoon) {
                            const isComplete = (activity.type === 'parametros' && dataAfternoon.value !== null) || 
                                             (activity.type === 'chequeo' && (dataAfternoon.status === 'ok' || dataAfternoon.oilLevel));
                            
                            if (!isComplete) {
                                dailyLogs[date].sections[section.id].activities[activityKeyAfternoon].incomplete = true;
                                dailyLogs[date].sections[section.id].activities[activityKeyAfternoon].incompleteAlert = '‚ö†Ô∏è No realizada';
                                
                                // Registrar en lista de no completadas
                                notCompletedList.push({
                                    id: Date.now() + Math.random(),
                                    date: date,
                                    sectionId: section.id,
                                    sectionName: section.name,
                                    activityId: activity.id,
                                    activityName: `${activity.name} (Tarde)`,
                                    activityType: activity.type,
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                    }
                });
            });
            
            // Guardar dailyLogs actualizado en Firebase
            await database.ref(`dailyLogs/${date}`).set(dailyLogs[date]);
            
            // Guardar actividades no completadas en nueva colecci√≥n
            if (notCompletedList.length > 0) {
                console.log(`üìù Registrando ${notCompletedList.length} actividades no realizadas`);
                
                // Guardar en notCompletedActivities
                for (const item of notCompletedList) {
                    await notCompletedActivitiesRef.child(date).push(item);
                    
                    // Crear alerta para cada actividad no completada
                    await alertsRef.push({
                        id: Date.now() + Math.random(),
                        type: 'not_completed',
                        date: date,
                        section: item.sectionName,
                        activity: item.activityName,
                        message: `No se realiz√≥: ${item.activityName} el ${formatDateForDisplay(date)}`,
                        severity: 'warning',
                        read: false,
                        createdAt: new Date().toISOString()
                    });
                }
                
                console.log(`‚úÖ ${notCompletedList.length} actividades no realizadas registradas`);
            }
        }
        
        function startDailyRenewal() {
            // Verificar cada 5 minutos si cambi√≥ el d√≠a
            setInterval(checkAndRenewDay, 5 * 60 * 1000); // 5 minutos
            
            console.log('üîÑ Renovaci√≥n autom√°tica iniciada (verifica cada 5 minutos)');
        }
        
        // ==================== RELOJ DEL SISTEMA ====================
        
        function updateSystemClock() {
            const now = new Date();
            
            // Formatear hora (HH:MM:SS)
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            
            // Formatear fecha
            const dateString = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Obtener d√≠a operacional
            const operationalDate = getOperationalDate();
            const operationalDateFormatted = new Date(operationalDate + 'T00:00:00').toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Actualizar elementos
            const clockTime = document.getElementById('clockTime');
            const clockDate = document.getElementById('clockDate');
            const clockDay = document.getElementById('clockDay');
            
            if (clockTime) {
                clockTime.textContent = timeString;
            } else {
                console.error('‚ùå clockTime element not found!');
            }
            
            if (clockDate) {
                clockDate.textContent = dateString;
            } else {
                console.error('‚ùå clockDate element not found!');
            }
            
            if (clockDay) {
                clockDay.textContent = `D√≠a operacional: ${operationalDateFormatted}`;
            } else {
                console.error('‚ùå clockDay element not found!');
            }
        }
        
        function startSystemClock() {
            console.log('‚è∞ Iniciando reloj del sistema...');
            updateSystemClock(); // Actualizar inmediatamente
            setInterval(updateSystemClock, 1000); // Actualizar cada segundo
            console.log('‚úÖ Reloj iniciado');
        }
    </script>
    
    <!-- ==================== PWA SERVICE WORKER ==================== -->
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ PWA: Service Worker registrado', registration.scope);
                        
                        // Verificar actualizaciones cada 30 segundos
                        setInterval(() => {
                            registration.update();
                        }, 30000);
                        
                        // Escuchar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ PWA: Nueva versi√≥n detectada');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('‚úÖ PWA: Nueva versi√≥n lista');
                                    // La app se actualizar√° en la pr√≥xima recarga
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('‚ùå PWA: Error al registrar Service Worker:', error);
                    });
                
                // Escuchar mensajes del Service Worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                        const updateType = event.data.updateType;
                        const version = event.data.version;
                        
                        console.log('üì¢ PWA: Actualizaci√≥n disponible -', version, 'Tipo:', updateType);
                        
                        if (updateType === 'critical') {
                            // Actualizaci√≥n cr√≠tica - forzar recarga
                            if (confirm('‚ö†Ô∏è Actualizaci√≥n cr√≠tica disponible.\n\nLa aplicaci√≥n se recargar√° ahora.')) {
                                window.location.reload();
                            }
                        } else if (updateType === 'major') {
                            // Actualizaci√≥n importante - notificar
                            showUpdateNotification(version);
                        }
                        // Si es 'minor', se actualiza silenciosamente en la pr√≥xima recarga
                    }
                });
            });
        } else {
            console.warn('‚ö†Ô∏è PWA: Service Workers no soportados en este navegador');
        }
        
        // Mostrar notificaci√≥n de actualizaci√≥n
        function showUpdateNotification(version) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 15px;
                font-family: Arial, sans-serif;
                animation: slideDown 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="flex: 1;">
                    <strong style="display: block; margin-bottom: 5px;">üîÑ Nueva versi√≥n disponible</strong>
                    <small style="opacity: 0.9;">Versi√≥n ${version} - Se actualizar√° al recargar</small>
                </div>
                <button onclick="window.location.reload()" 
                        style="background: white; color: #667eea; border: none; padding: 8px 16px; 
                               border-radius: 5px; cursor: pointer; font-weight: bold;">
                    Actualizar Ahora
                </button>
                <button onclick="this.parentElement.remove()" 
                        style="background: transparent; color: white; border: 1px solid white; 
                               padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                    Despu√©s
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-cerrar despu√©s de 10 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // CSS para animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateX(-50%) translateY(-100px);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Detectar cuando la app se instala
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì± PWA: Instalaci√≥n disponible');
            e.preventDefault();
            deferredPrompt = e;
            
            // Opcional: Mostrar bot√≥n de instalaci√≥n personalizado
            // showInstallButton();
        });
        
        // Detectar cuando la app se instal√≥ exitosamente
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA: Aplicaci√≥n instalada exitosamente');
            deferredPrompt = null;
        });
        
        // Detectar modo standalone (cuando se abre como PWA instalada)
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            console.log('üì± PWA: Ejecutando en modo standalone (instalada)');
        }
    </script>

</body>
</html>
